Modustri.controller("DashboardCtrl",["$log","$scope","$routeParams","$location","$modal","$http","CustomerServices","MachineServices","InsServices","UserServices","AuthServices","ScoreBoardServices","Utilities","AppSettings","DealerServices","$filter","$q",function(e,t,n,i,r,o,a,l,s,c,u,f,m,d,h,p,g){"use strict";function b(){if(moment(t.filterValue_FromDate)>moment(t.filterValue_ToDate))return void alert("Enter a To Date later than From Date!");t.fromUnix=moment(t.filterValue_FromDate),t.toUnix=moment(t.filterValue_ToDate),t.fromUnix.subtract(5,"hours"),t.toUnix.add(19,"hours"),t.fromUnix=t.fromUnix.unix(),t.toUnix=t.toUnix.unix(),t.filter_today=moment().unix(),t.filter_thisweek=moment().weekday(0).unix(),t.filter_lastweek=moment().weekday(-7).unix(),t.filter_thismonth=moment().date(1).unix(),t.filter_lastmonth=moment().add(-1,"months").date(1).unix(),t.filter_Months=[];for(var e=moment(t.filterValue_FromDate),n=moment(t.filterValue_ToDate).add(1,"months").date(-1).unix();e.unix()<n;)t.filter_Months.push({value:e.unix(),text:e.format("MMM YYYY")}),e=e.add(1,"months");t.InspectionCache={},t.Inspections=[],s.getByDealerIdStartEnd(u.getDealerID(),t.fromUnix,t.toUnix).then(function(e){var n=e.data.results;t.InspectionCache=n,t.UpdateDispatch()})}function M(){var e=new google.maps.LatLngBounds;for(var t in U){var n=parseFloat(U[t].position.k,10),i=parseFloat(U[t].position.B,10),r=new google.maps.LatLng(n,i);e.extend(r)}Y.fitBounds(e)}function v(){R<U.length?(U[R].setMap(Y),R++):(clearInterval(O),M())}function y(){var e=[];t.filter_Customers={},angular.forEach(t.Inspections,function(n){"undefined"!=typeof n.inspection_obj.customer&&null!==n.inspection_obj.customer&&-1===e.indexOf(n.inspection_obj.customer.id)&&(t.filter_Customers[n.inspection_obj.customer.id]=n.inspection_obj.customer,e.push(n.inspection_obj.customer.id))})}function V(){var e=38.582436,t=-30.386832,n=new google.maps.LatLng(e,t),i={zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,center:n};Y=new google.maps.Map(document.getElementById("dispatch-manager-map"),i)}function w(){x(),angular.forEach(t.Inspections,function(e){t.tblFilterCustomer(e)&&t.tblFilterModel(e)&&t.tblFilterFromRating(e)&&t.tblFilterMonth(e)&&t.tblFilterLastThis(e)&&t.tblFilterKeyword(e)&&D(e),R=0,O=setInterval(v,100)}),console.dir(U);for(var e in U)U[e].setMap(Y)}function D(e){var t="./images/tmp.png";if(0!==e.job_site_id&&"undefined"!=typeof e.inspection_obj.jobsite){var n=e.inspection_obj.machine.main_image_id;n!==!1&&n>0?(t=d.BASE_URL+"imgtmb/"+n+"/",j(t,e)):(t="images/tmp.png",j(t,e))}}function j(e,n){if(0!==n.inspection_obj.jobsite.lat&&0!==n.inspection_obj.jobsite.lon){var i=new google.maps.LatLng(n.inspection_obj.jobsite.lat,n.inspection_obj.jobsite.lon),r="Not Set";"undefined"!=typeof n.inspection_obj.customer&&(r=n.inspection_obj.customer.name);var o=new google.maps.InfoWindow({content:k(e,n,r)});t.InfoWindows.push(o);var a=new google.maps.Marker({position:i,title:"Inspection Location",icon:n.markerIcon});google.maps.event.addListener(a,"click",function(){for(var e=0;e<t.InfoWindows.length;e++)t.InfoWindows[e].close();o.open(Y,a)}),U.push(a)}}function k(e,t,n){var i="";t.inspection_obj.hasOwnProperty("user")&&(i=t.inspection_obj.user.username);var r='<div class="map-data-container"><div class="map-image"><img alt="Inspection '+t.id+'" src="'+e+'"/></div><div class="map-data"><h3><a href="#/inspections/'+t.id+'">Inspection '+t.id+"</a></h3>Inspector: <strong>"+i+'</strong><br />Serial: <strong><a href="#/machines/'+t.machine_id+'">'+t.inspection_obj.machine.serial+"</a></strong><br />Customer: <strong>"+n+"</strong><br /></div></div>";return r}function I(e){for(var t=0;t<U.length;t++)U[t].setMap(e)}function F(){I(null)}function x(){F(),U=[]}function C(e){var t;return"undefined"!=typeof e&&null!==e&&"Hi"!==e&&"Lo"!==e&&"NA"!==e&&""!==e?parseFloat(e):void 0}function L(e){return"undefined"==typeof e||""===e||null===e?"red":e>69?"red":e>30&&70>e?"orange":31>e?"green":void 0}function T(e,t){var n,i,r=e.inspection_obj,o=[],a=[];t.data.hasOwnProperty("results")&&t.data.results.length>0&&(r.imgs=[],_.each(t.data.results,function(e,t,n){_.each(r.results,function(t,n,i){if("string"!=typeof t){var l=t.length;if(l>0)for(var s=0;l>s;s++)t[s].hasOwnProperty("left")&&t[s].left.hasOwnProperty("image_timestamp")&&e.timestamp===t[s].left.image_timestamp&&(r.results[n][s].left.image_url=d.BASE_URL+"imgtmb/"+e.id+"/",r.results[n][s].left.image_full_url=d.BASE_URL+"img/"+e.id+"/",o[s]=document.createElement("img"),o[s].src="",r.totalimages++,r.images.push({comp:n+" left",image:r.results[n][s].left.image_full_url})),t[s].hasOwnProperty("right")&&t[s].right.hasOwnProperty("image_timestamp")&&e.timestamp===t[s].right.image_timestamp&&(r.results[n][s].right.image_url=d.BASE_URL+"imgtmb/"+e.id+"/",r.results[n][s].right.image_full_url=d.BASE_URL+"img/"+e.id+"/",a[s]=document.createElement("img"),a[s].src="",r.totalimages++,r.images.push({comp:n+" right",image:r.results[n][s].right.image_full_url}))}})}));var l=["track_links left","track_links right","bushings left","bushings right","track_shoes left","track_shoes right","idlers_front left","idlers_front right","idlers_rear left","idlers_rear right","carrier_rollers left","carrier_rollers right","track_rollers left","track_rollers right","sprockets left","sprockets right"];r.images=_.sortBy(r.images,function(e){return _.indexOf(l,e.comp)})}t.InspectionCache={},t.FilterLock=!1,t.FilterMD=function(){t.FilterLock=!1},t.FilterMU=function(){t.FilterLock=!1},t.filterValue_FromDate=localStorage.getItem("filterValue_FromDate")?localStorage.getItem("filterValue_FromDate"):moment().subtract(1,"months").format("MM/DD/YYYY"),t.filterValue_ToDate=localStorage.getItem("filterValue_ToDate")?localStorage.getItem("filterValue_ToDate"):moment().format("MM/DD/YYYY"),t.$watch("filterValue_FromDate",function(e){localStorage.setItem("filterValue_FromDate",e)}),t.$watch("filterValue_ToDate",function(e){localStorage.setItem("filterValue_ToDate",e)}),t.filterValue_Customer=[],t.filterValue_Model=[],t.filterValue_Month=[],t.filterValue_LastThis=0,t.filterValue_FromRating=0,t.filterValue_ToRating=120,t.filterValue_NA=!1,t.filterValue_Keyword="",t.filterMenu={customer:!1,customer_filter:"",model:!1,model_filter:""};var S=$("#spinner");S.css("width","24px").css("height","24px"),S.show(),u.checkUserCreds(),t.UserSettings=u.getUserSettings();var A=moment();s.getInspectionCountByRange(moment("01-01-"+A.year(),"MM-DD-YYYY").unix(),A.unix()).then(function(e){e.data.results.length>0&&(t.Trend.ytd_inspections=e.data.results[0].dealer_inspections,t.readySalesWidget=!0)}),t.filter_Customers={},t.filter_Models={},t.filter_Months=[],l.queryModels().then(function(e){angular.forEach(e.data.results,function(e){t.filter_Models[e.id]=e})}),t.AllMachineActionDates=[],t.MachineActions=[],f.getAllScoreBoardData("actions",function(e){t.MachineActions=e.results}),f.getAllScoreBoardData("machineactiondates",function(e){t.AllMachineActionDates=e.results}),t.Trend={ytd_inspections:0,ytd_sales:0,revenue:0,missed_opportunities:0,monthly_teamgoals:0,user_engagement:0,customer_engagement:0},b();var Y,U=[];t.InfoWindows=[],t.showTrends=1,t.showFilter=1,t.showMap=1,t.showhideTrends=function(e){t.showTrends=e},t.showhideFilter=function(e){t.showFilter=e},t.showhideMap=function(e){t.showMap=e},t.DispatchReady=!1,t.Inspections=[],t.ApplyFilters=function(){t.DispatchReady=!1,b()},t.ClearFilters=function(){t.filterValue_Customer=[],t.filterValue_Model=[],t.filterValue_Month=[],t.filterValue_LastThis=0,t.filterValue_FromRating=0,t.filterValue_ToRating=120,t.filterValue_NA=!1,t.filterValue_Keyword="",t.filterValue_FromDate=moment().subtract(1,"months").format("MM/DD/YYYY"),t.filterValue_ToDate=moment().format("MM/DD/YYYY")},t.Spin=S,t.Loaded=!1,t.$watch("Loaded",function(e,n){e!==n&&(S.hide(),t.DispatchReady=!0)});var O=!1,R=0;t.UpdateDispatch=function(){x();var e=t.InspectionCache.length,n=0;angular.forEach(t.InspectionCache,function(i,r){var o=parseInt(i.timestamp,10),s=parseInt(t.fromUnix,10),c=parseInt(t.toUnix,10);if(o>s&&c>o){i.hasOwnProperty("datestring")||(i.datestring=m.getDatestring(i.timestamp)),i.inspection_obj.hasOwnProperty("customer")?i.customer_name=i.inspection_obj.customer.name:a.get(i.customer_id).then(function(e){i.customer_name=e.data.results.name});var u=[];i.components=[],i.inspection_obj.totalimages=0,i.inspection_obj.images=[],angular.forEach(i.inspection_obj.results,function(e,t){if(!("undefined"==typeof e[0]||"undefined"==typeof e[0].left&&"undefined"==typeof e[0].right||"undefined"==typeof e[0].left.percentage&&"undefined"==typeof e[0].right.percentage))for(var n=0;n<e.length;n++){u.push(C(e[n].left.percentage)),u.push(C(e[n].right.percentage)),e[n].component_type=t,e[n].left.percent=C(e[n].left.percentage),e[n].left.color=L(e[n].left.percent),e[n].right.percent=C(e[n].right.percentage),e[n].right.color=L(e[n].right.percent);var r=e[n].left.measured,o=!1,a=e[n].right.measured,l=!1;e[n].left.hasOwnProperty("measured_metric")||(0!==r&&r!==!1&&(o=r/.03937),e[n].left.measured_metric=isNaN(o)?"":Math.round(o,2)),e[n].right.hasOwnProperty("measured_metric")||(0!==a&&(l=a/.03937),e[n].right.measured_metric=isNaN(l)?"":Math.round(l,2)),i.components.push(e[n])}});var f=u.sort(function(e,t){return t-e});"undefined"==typeof f[0]?(i.rating="N/A",i.rating_value=-1,i.color=""):(i.rating=f[0].toString()+"%",i.rating_value=f[0]),i.color=L(i.rating_value),i.markerIcon="http://maps.google.com/mapfiles/ms/icons/"+i.color+"-dot.png";try{""!=i.inspection_obj.machine.id&&""===i.inspection_obj.machine.serial&&l.get(i.inspection_obj.machine.id).then(function(e){console.log("Called get machine"),i.inspection_obj.machine.serial=e.data.results.serial})}catch(d){}i.opportunity="",angular.forEach(t.AllMachineActionDates,function(e,n){e.inspection_id==i.id&&(i.opportunity=i.opportunity+t.MachineActions[parseInt(e.action_id)-1].abr+" ")}),i.checked=!1,t.Inspections.push(i),i.show_components=0,D(i),n++,n>=e&&(t.Loaded=!0),void 0==i.inspection_obj.inspector&&void 0!=i.inspection_obj.user&&void 0!=i.inspection_obj.user.username&&(i.inspection_obj.inspector=i.inspection_obj.user.username)}else n++}),O=setInterval(v,100),t.DispatchReady=!0,y()},t.preventHide=function(e){void 0!=e&&(e.preventDefault(),e.stopPropagation())},t.filterByCustomerText=function(){var e=[];return angular.forEach(t.filterValue_Customer,function(n){e.push(t.filter_Customers[n].name)}),0==e.length?"-- Filter by Customer --":e.join(", ")},t.filterByModelText=function(){var e=[];return angular.forEach(t.filterValue_Model,function(n){e.push(t.filter_Models[n].model)}),0==e.length?"-- Filter by Model --":e.join(", ")},t.filterByCustomer=function(e,n){t.filterValue_Customer.indexOf(e)<0?t.filterValue_Customer.push(e):t.filterValue_Customer.splice(t.filterValue_Customer.indexOf(e),1),void 0!=n&&(n.preventDefault(),n.stopPropagation(),t.filterMenu.customer=!t.filterMenu.customer)},t.tblFilterCustomer=function(e){return 0==t.filterValue_Customer.length?!0:e.inspection_obj.hasOwnProperty("customer")&&-1!=t.filterValue_Customer.indexOf(e.inspection_obj.customer.id)?!0:!1},t.filterByModel=function(e,n){t.filterValue_Model.indexOf(e)<0?t.filterValue_Model.push(e):t.filterValue_Model.splice(t.filterValue_Model.indexOf(e),1),void 0!=n&&(n.preventDefault(),n.stopPropagation(),t.filterMenu.model=!t.filterMenu.model)},t.tblFilterModel=function(e){return 0==t.filterValue_Model.length?!0:e.inspection_obj.hasOwnProperty("machine")&&-1!=t.filterValue_Model.indexOf(e.inspection_obj.machine.model_id)?!0:!1},t.tblFilterFromRating=function(e){return e.rating_value>=t.filterValue_FromRating&&e.rating_value<=t.filterValue_ToRating||t.filterValue_NA&&-1==e.rating_value?!0:!1},t.filterByMonth=function(e){t.filterValue_LastThis=0,t.filterValue_Month.indexOf(e)<0?t.filterValue_Month.push(e):t.filterValue_Month.splice(t.filterValue_Month.indexOf(e),1)},t.tblFilterMonth=function(e){if(t.filterValue_Month.length>0){for(var n=!1,i=0;i<t.filterValue_Month.length;i++){var r=moment(t.filterValue_Month[i],"X"),o=moment(e.timestamp,"X");r.month()===o.month()&&r.year()===o.year()&&(n=!0)}return n}return!0},t.tblFilterKeyword=function(e){return""==t.filterValue_Keyword?!0:e.inspection_jsonstring.toLowerCase().indexOf(t.filterValue_Keyword.toLowerCase())>=0?!0:t.filterValue_Keyword.toLowerCase()==(e.inspection_obj.manufacturer.company+" "+e.inspection_obj.machine.model).toLowerCase()?!0:!1},t.filterByLastThis=function(e){t.filterValue_LastThis===e?t.filterValue_LastThis=0:(t.filterValue_LastThis=e,t.filterValue_Month=[]),t.filterValue_Month=[]},t.tblFilterLastThis=function(e){var n=moment(e.datestring,"MM/DD/YYYY"),i=moment();switch(t.filterValue_LastThis){case 1:if(n.add(1,"weeks"),n.week()===i.week()&&n.year()===i.year())return!0;break;case 2:if(n.add(1,"months"),n.month()===i.month()&&n.year()===i.year())return!0;break;case 3:if(n.year()===i.year()&&n.month()===i.month()&&n.date()===i.date())return!0;break;case 4:if(n.week()===i.week()&&n.year()===i.year())return!0;break;case 5:if(n.month()===i.month()&&n.year()===i.year())return!0;break;default:return!0}return!1},t.getFilterMonthsLabel=function(){var e=[];return angular.forEach(t.filter_Months,function(n){-1!=t.filterValue_Month.indexOf(n.value)&&e.push(n.text)}),0==e.length?"Select a Month":e.join(", ")},t.$watch("filterValue_Customer",function(e,t){angular.equals(e,t)||w()}),t.$watch("filterValue_Model",function(e,t){angular.equals(e,t)||w()}),t.$watch("filterValue_FromRating",function(e,n){e===n||t.FilterLock||w()}),t.$watch("filterValue_ToRating",function(e,n){e===n||t.FilterLock||w()}),t.$watch("filterValue_NA",function(e,n){e===n||t.FilterLock||w()}),t.$watch("filterValue_Month",function(e,t){angular.equals(e,t)||w()}),t.$watch("filterValue_LastThis",function(e,t){e!==t&&w()}),t.$watch("filterValue_Keyword",function(e,t){e!==t&&w()}),t.usv_component={track_links:{name:"Link",icon_cls:"links-btn"},bushings:{name:"Bushing",icon_cls:"bushings-btn"},track_shoes:{name:"Shoe",icon_cls:"shoes-btn"},idlers_front:{name:"Front Idler",icon_cls:"idlers-btn"},idlers_rear:{name:"Rear Idler",icon_cls:"idlers-btn"},carrier_rollers:{name:"Carrier Roller",icon_cls:"carrier-rollers-btn"},track_rollers:{name:"Track Roller",icon_cls:"track-rollers-btn"},sprockets:{name:"Sprocket",icon_cls:"sprockets-btn"}},V(),t.deleteInspections=function(){if(confirm("Are you sure you want to delete selected inspections?"))for(var e=0;e<t.Inspections.length;e++)t.Inspections[e].checked&&(s.del(t.Inspections[e].id).then(function(e){}),t.Inspections.splice(e,1),e--)},t.openCarousel=function(e){t.inspection=e;var n=r.open({templateUrl:"dashboard-carousel.html",controller:"DashboardCarouselCtrl",resolve:{inspection:function(){return t.inspection}},windowClass:"dashboard-carousel-modal"})}}]),Modustri.controller("DashboardCarouselCtrl",function(e,t,n){e.images=n.inspection_obj.images,e.insid=n.id,e.carouselIndex=0,e.close=function(){t.dismiss("cancel")}});
//# sourceMappingURL=./dashboard-min.js.map
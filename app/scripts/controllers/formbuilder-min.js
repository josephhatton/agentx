Modustri.controller("FormBuilderCtrl",["$log","$scope","$routeParams","$location","$http","$timeout","CustomerServices","MachineServices","TemplateServices","UserServices","AuthServices","Utilities","AppSettings","DealerServices","InsServices","$filter","$q","$modal",function(e,t,n,i,o,s,p,r,a,l,c,d,u,f,m,h,y,T){"use strict";function g(e){var n=e.data.results;if(void 0!==n){t.ListTemplates.length=0;for(var i in n){var o=n[i],s=new moment.unix(o.modified).format("MMM DD, YY");0===o.modified&&(s="N/A"),o.ts=t.TS(),o.type="template",o.date=s,t.ListTemplates.push(o)}t.ListTemplates=_.sortBy(t.ListTemplates,function(e){return e.title})}}function v(e){var n=e.data.results;if(void 0!==n){t.ListInspections.length=0;for(var i in n){var o=n[i],s={title:o.label,description:"",id:o.id,type:"instype",ts:t.TS()};s.date=o.modified?new moment.unix(o.modified).format("MMM DD, YY"):"N/A",t.ListInspections.push(s)}t.ListInspections=_.sortBy(t.ListInspections,function(e){return e.title})}}function w(e){t.TemplateInsTypes=e.data.results}function k(e){var n=e.data.results;if(void 0!==n){t.ListTasks.length=0;for(var i in n){var o=n[i];o.ts=t.TS(),o.title=o.name,o.type="task",o.description="Steps: "+o.instructions.steps.length,t.ListTasks.push(o)}t.ListTasks=_.sortBy(t.ListTasks,function(e){return e.title});for(var s in t.ListTasks){var p=t.ListTasks[s],r=_.find(t.ListInspections,function(e){return e.id==p.inspection_type_id});void 0!=r&&(p.inspection_type=r)}}}t.Debug=function(){console.dir(t.NewTask)},t.TS=function(){var e=(new Date).getTime()+8999*Math.random()+1e3;return e},t.UUID=function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)});return t},t.TemplateBlank=function(){return{id:t.UUID(),title:"",dealer_id:0,model_id:0,modified:"",description:""}},t.InspectionTypeBlank=function(){return{id:t.UUID(),title:"",tasks:[]}},t.TemplateInspectionTypeBlank=function(){return{id:t.UUID(),template_id:"",inspection_type_id:""}},t.TaskBlank=function(){return{id:t.UUID(),component_id:0,user_id:0,sort_order:0,modified:0,required:0,parent_id:0,instructions:{},inspection_type_id:0,name:""}},t.Spin=$("#spinner").css("width","24px").css("height","24px"),t.Spin.show(),t.Loaded=!1,t.$watch("Loaded",function(e,n){e?t.Spin.hide():t.Spin.show()}),c.checkUserCreds(),t.UserSettings=c.getUserSettings(),f.getDealerImg(c.getDealerID()).then(function(e){if("image_id"in e.data.results&&null!==e.data.results.obj&&null!==e.data.results.image_id){var t=u.BASE_URL+"img/"+e.data.results.image_id+"/";$("#logo").css("background-image","url("+t+")").css("width","250px"),$(".logo-wrapper").css("width","250px")}}),t.ListTemplates=[],t.ListInspections=[],t.TemplateInsTypes=[],t.ListTasks=[],t.ListForms=[],t.ListRecents=[],t.ListFormsByModustri=[],t.ListFormsByYou=[],t.TaskTypes=[{title:"Attention",description:"This allows a call to action notice, of either an Information or Warning type.",type:"attention"},{title:"Yes or No",description:"This allows a True/False type question of several varieties to be created",type:"boolean"},{title:"Comment",description:"This allows for freeform user feedback in a textfield.",type:"comment"},{title:"Goal",description:"This allows for the purpose of this step to be defined",type:"goal"},{title:"Help",description:"Supports multiple types of help media for the current step",type:"help"},{title:"Input field",description:"Multiple formats of single field inputs",type:"input"},{title:"Option Picker",description:"Allows for the creation of multiple option inputs",type:"option"},{title:"Photos",description:"Photo uploading, review",type:"photos"},{title:"Rating",description:"Customizable rating widget",type:"rating"}];var x=a.getTemplateInspectionTypes(),I=a.getTasks(),S=a.getTemplates(),b=a.getInspectionTypes();S.then(function(e){g(e)}),b.then(function(e){v(e)}),x.then(function(e){w(e)}),I.then(function(e){k(e)}),y.all([S,b,x,I]).then(function(e){t.ListForms=t.ListTemplates.concat(t.ListInspections),t.ListForms=_.sortBy(t.ListForms,function(e){return e.title}),angular.copy(t.ListForms,t.ListRecents);for(var n in t.ListTasks){var i=t.ListTasks[n],o=_.find(t.ListInspections,function(e){return e.id==i.inspection_type_id});void 0!=o&&(i.inspection_type=o)}t.Loaded=!0}),t.GetElemView=function(e){return"template"===e.type?(t.Template=e,"views/partials/formbuilder/templates/builder_element.html"):"task"===e.type?(t.Task=e,"views/partials/formbuilder/tasks/builder_element.html"):"instype"===e.type?(t.Inspection=e,"views/partials/formbuilder/inspections/builder_element.html"):void 0},t.NewTemplate=t.TemplateBlank(),t.IsNewTemplate=!0,t.DroppedObjs=[],n.ID&&i.path().startsWith("/templates")&&a.getTemplateById(n.ID).then(function(e){var n=e.data.results;t.NewTemplate={id:n.id,title:n.title,dealer_id:n.dealer_id,model_id:n.model_id,modified:n.modified,description:n.description},t.IsNewTemplate=!1,a.getTemplateInspectionTypesByTemplate(n.id).then(function(e){var n=e.data.results;n=n.sort(function(e,t){return e.sort_order-t.sort_order});var i=[];for(var o in n)i.push(a.getInspectionType(n[o].inspection_type_id)),i.push(a.getTasksByInspectionType(n[o].inspection_type_id));y.all(i).then(function(e){var n;for(o=0;o<e.length/2;o++)n=e[2*o].data.results,n.title=n.label,n.type="instype",n.tasks=e[2*o+1].data.results,t.DroppedObjs.push(n)})}),t.Template=t.NewTemplate}),t.SaveTemplate=function(e){if(""==t.NewTemplate.title.trim())return void alert("Inspection Title should be filled!");t.Loaded=!1,e&&(t.NewTemplate.id=t.UUID());var n=t.NewTemplate,o=[];angular.copy(t.DroppedObjs,o),a.saveTemplate(n).success(function(e){a.removeTemplateInspectionTypesByTemplate(n.id).then(function(e){for(var s in o)if("instype"==o[s].type){var p=t.TemplateInspectionTypeBlank();p.template_id=n.id,p.inspection_type_id=t.DroppedObjs[s].id,p.sort_order=s,a.saveTemplateInspectionType(p)}t.IsNewTemplate=!1,i.url("templates/"+n.id),t.Loaded=!0})})},t.DropElement=function(e,n){a.getTasksByInspectionType(e.id).then(function(t){e.tasks=t.data.results,angular.forEach(e.tasks,function(e,t){e.expanded=!1})});var i=null;return i=_.find(t.DroppedObjs,function(t){return t.id==e.id}),null!=i?void console.log("You are trying to add duplicates"):void t.DroppedObjs.push(e)},t.MoveElement=function(e,n,i){var o=t.DroppedObjs.indexOf(n);if(o>-1){console.log(n.type);var s=t.DroppedObjs[e];t.DroppedObjs[e]=n,t.DroppedObjs[o]=s}else console.log("add"),t.DropElement(n,i)},t.removeInDroppedObjs=function(e){t.DroppedObjs.splice(e,1)},t.keywordFilterInspectionTypeBox="",t.filterInspectionTypeBox=function(e){return""==t.keywordFilterInspectionTypeBox?!0:e.title.toLowerCase().indexOf(t.keywordFilterInspectionTypeBox.toLowerCase())>=0?!0:!1},t.NewInspectionType=t.InspectionTypeBlank(),t.IsNewInspectionType=!0,n.ID&&i.path().startsWith("/inspections")&&a.getInspectionType(n.ID).then(function(e){var n=e.data.results;t.NewInspectionType={id:n.id,title:n.label,label:n.label},t.IsNewInspectionType=!1,a.getTasksByInspectionType(n.id).then(function(e){t.NewInspectionType.tasks=e.data.results,t.NewInspectionType.tasks=t.NewInspectionType.tasks.sort(function(e,t){return e.sort_order-t.sort_order}),angular.forEach(t.NewInspectionType.tasks,function(e,n){e.expanded=!1,e.ts=t.TS(),e.title=e.name,e.type="task",e.description="Steps: "+e.instructions.steps.length})}),t.Inspection=t.NewInspectionType}),t.SaveInspectionType=function(e){if(""==t.NewInspectionType.title.trim())return void alert("Section Title should be filled!");t.Loaded=!1,e&&(t.NewInspectionType.id=t.UUID());var n=t.NewInspectionType;n.label=n.title,a.saveInspectionType(n).success(function(o){a.removeTasksByInspectionType(n.id).success(function(o){for(var s in n.tasks){e&&(n.tasks[s].id=t.UUID()),n.tasks[s].inspection_type_id=n.id;var p={};angular.copy(n.tasks[s],p),p.instructions=JSON.stringify({steps:p.instructions.steps}),p.sort_order=s,a.saveTask(p)}t.Loaded=!0,t.IsNewInspectionType=!1,i.url("inspections/"+n.id)})})},t.DropTask=function(e,n){var i=t.NewInspectionType.tasks.indexOf(e);return i>-1?void console.log("You are trying to add duplicates"):(e.id=t.UUID(),void t.NewInspectionType.tasks.push(e))},t.MoveTask=function(e,n,i){var o=t.NewInspectionType.tasks.indexOf(n);if(o>-1){console.log(n.type);var s=t.NewInspectionType.tasks[e];t.NewInspectionType.tasks[e]=n,t.NewInspectionType.tasks[o]=s}else console.log("add"),t.DropTask(n,i)},t.removeInDroppedTasks=function(e){t.NewInspectionType.tasks.splice(e,1)},t.keywordFilterTaskBox="",t.filterTaskBox=function(e){return""==t.keywordFilterTaskBox?!0:e.title.toLowerCase().indexOf(t.keywordFilterTaskBox.toLowerCase())>=0?!0:!1},t.NewTask=t.TaskBlank(),t.NewSteps=[],t.MyWatches=[],t.tplstr="Test",t.TempOpt="",t.SaveTask=function(){console.log("Called save"),t.NewTask.instructions={steps:t.NewSteps};var e=t.NewTask,n=t.NewSteps;for(var i in n)for(var o in n[i])delete n[i].$$hashKey,delete n[i].TempOpt;e.instructions=JSON.stringify({steps:n}),console.dir(e),a.saveTask(e).success(function(e){t.NewTask.id=e.results.id})},t.RemoveStep=function(e){t.ClearRatingWatches(),console.log(e+" - "+name),window.confirm("Are you sure?\nThis will delete all parts\nof this step")&&s(function(){t.NewSteps.splice(e,1)},0,!0)},t.AddStep=function(){var e={};t.NewSteps.push(e)},t.AppendStep=function(e,n,i){switch(void 0===t.NewSteps[e]&&(t.NewSteps[e]={}),i){case"rating":n.hasOwnProperty("rating_max")||(n.rating_max=10),t.NewSteps[e][i]=n;break;case"boolean":n.hasOwnProperty("boolean_default")||(n.boolean_default=0),n.hasOwnProperty("boolean_type")||(n.boolean_type="No / Yes")}console.log(e,i,n),t.NewSteps[e][i]=n},t.DropStep=function(e,n){if(void 0===e&&(0===t.NewSteps.length&&t.AddStep(),e=0),console.log(e,n),n.hasOwnProperty("instructions"))for(var i in n.instructions.steps){var o={},s=t.NewSteps.push(o)-1;for(var p in n.instructions.steps[i]){var r=n.instructions.steps[i][p];t.NewSteps.hasOwnProperty(s)||(t.NewSteps[s]={}),t.AppendStep(s,r,p)}}else{var a={};angular.copy(t.StepBlanks[n.type],a),"goal"==n.type?t.AppendStep(e,t.StepBlanks[n.type],n.type):t.AppendStep(e,a,n.type)}},t.MoveStep=function(e,n){var i=e+n;if(console.log("bi:"+i+" i "+e+" x "+n),t.NewSteps.length>0&&i>=0&&i<t.NewSteps.length){var o=t.NewSteps[e],s=t.NewSteps[i];t.NewSteps[e]=s,t.NewSteps[i]=o}},t.GetInsByID=function(e){for(var n in t.ListInspections){var i=t.ListInspections[n];if(i.id===e)return i.title}return"Not set"},t.AddOpt=function(e){if(console.dir(e),""===e.TempOpt)return void console.log("no tempopt");var t=e.TempOpt;console.log(t),e.option.option_choices.push(t),e.TempOpt=""},t.RemoveWidget=function(e,n){console.log(e+" - "+n),window.confirm("Are you sure?")&&s(function(){delete t.NewSteps[e][n]},0,!0)},t.RemoveOption=function(e,t){console.log(e),console.dir(t),window.confirm("Are you sure?")&&s(function(){t.option.option_choices.splice(e,1)},0,!0)},t.RebuildRatingWatches=function(){for(var e in t.NewSteps)t.NewSteps[e].hasOwnProperty("rating")&&(console.log("adding watch to rating in step "+e),t.WatchRating(e))},t.ClearRatingWatches=function(){for(var e in t.MyWatches)console.log("clearing watch "+e),t.MyWatches[e](),t.MyWatches.splice(e,1)},t.WatchRating=function(e){var n="rating";console.dir(t.NewSteps[e][n]),t.MyWatches.push(t.$watch(function(i){return t.NewSteps[e][n].rating_max},function(i,o){i!==o&&(t.NewSteps[e][n].RateRender=!1,s(function(){t.NewSteps[e][n].RateRender=!0},0,!0))})),s(function(){t.NewSteps[e][n].RateRender=!0},0,!0)},t.ImgPath=function(e){console.log(e)},t.BuildTestBlank=function(){console.log("build test blank");var e={};e.goal="Test Step building",e.help={help_text:"Try to build an individual step of an inspection"},e.rating={directions:"This is a rating widget",rating_min:1,rating_max:10,rating_increment:.5,value:1},t.RateRender=!0,e.photos={directions:"Photo carousel / uploader",photos_numreq:0,value:!1},e.boolean={directions:"True or False input",boolean_default:0,boolean_req:0,boolean_type:0,value:0},e.option={directions:"Select Box input",option_choices:["Excellent","Acceptable","Poor"],option_default:0,option_size:"default",option_select:"single",value:0},e.attention={attention_text:"Call to action / warning",attention_type:"info"},e.comment={directions:"Please provide a comment",value:""},e.input={directions:"Enter a number",input_type:"decimal",input_max:99.99,input_min:-99.99,input_length:!1,input_length_int:4,input_length_dec:2,input_req:0,input_regex:"",input_size:"default",input_units:"inches",value:!1},console.dir(e),t.NewSteps.push(e)},t.StepBlanks={goal:" ",help:{help_text:"",help_photos:[],help_videos:[]},rating:{directions:" ",rating_min:1,rating_max:10,rating_increment:1},photos:{directions:"",photos_numreq:0},uci:{directions:"",uci_tool:"ultrasonic",uci_units:"inches"},"boolean":{directions:"",boolean_default:0,boolean_req:0,boolean_type:"0"},option:{directions:"",option_choices:[],option_default:0,option_size:"default",option_select:"single"},attention:{attention_text:"",attention_type:"info"},comment:{directions:""},input:{directions:"",input_type:"decimal",input_max:99.99,input_min:-99.99,input_length:!1,input_length_int:4,input_length_dec:2,input_req:0,input_regex:"",input_size:"default",input_units:"inches"}},t.open_createform=function(){var e=T.open({templateUrl:"views/partials/formbuilder/CreateFormModal.html",controller:"CreateFormModalCtrl",size:"sm",resolve:{},windowClass:"createform-modal"});e.result.then(function(e){"template"==e?i.path("templates"):"inspectiontype"==e&&i.path("inspections")})},t.open_taskmodal=function(e){var n=T.open({templateUrl:"views/partials/formbuilder/task.html",controller:"TaskModalCtrl",resolve:{taskid:function(){return e},instypes:function(){return t.ListInspections}},windowClass:"fb-taskbuilder-modal"});n.result.then(function(e){"ok"==e&&a.getTasks().then(function(e){k(e)})})},t.isActiveNav=function(e){var t=i.path(),n=t.match(/[^/].*[^/]/g),o=e.match(/[^/].*[^/]/g);return null!==n&&n.length>0&&(t="/"+n[0]),null!==o&&o.length>0&&(e="/"+o[0]),-1!==t.indexOf(e)?!0:!1}}]),Modustri.controller("CreateFormModalCtrl",function(e,t,n){e.formType={selected:""},e.ok=function(){n.close(e.formType.selected)},e.cancel=function(){n.dismiss("cancel")}}),Modustri.controller("TaskModalCtrl",function(e,t,n,i,o,s,p){e.task_id=s,e.mode,e.instypes=p,e.TS=function(){var e=(new Date).getTime()+8999*Math.random()+1e3;return e},e.UUID=function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)});return t},e.task_blank=function(){return{id:e.UUID(),component_id:0,user_id:0,sort_order:0,modified:0,required:0,parent_id:0,instructions:{steps:[]},inspection_type_id:0,name:""}},e.task_types=[{type:"attention",title:"Attention",description:"This allows a call to action notice, of either an Information or Warning type."},{type:"goal",title:"Goal",description:"This allows for the purpose of this step to be defined"},{type:"help",title:"Help",description:"Supports multiple types of help media for the current step"},{type:"rating",title:"Rating",description:"Customizable rating widget"},{type:"photos",title:"Photos",description:"Photo uploading, review"},{type:"boolean",title:"Yes or No",description:"This allows a True/False type question of several varieties to be created"},{type:"option",title:"Option Picker",description:"Allows for the creation of multiple option inputs"},{type:"comment",title:"Comment",description:"This allows for freeform user feedback in a textfield."},{type:"input",title:"Input field",description:"Multiple formats of single field inputs"}],e.task_type_blank=function(e){return"attention"==e?{attention_text:"",attention_type:"info"}:"goal"==e?"":"help"==e?{help_text:"",help_photos:[],help_videos:[]}:"rating"==e?{directions:" ",rating_min:1,rating_max:10,rating_increment:1}:"photos"==e?{directions:"",photos_numreq:0}:"boolean"==e?{directions:"",boolean_default:0,boolean_req:0,boolean_type:"0"}:"option"==e?{directions:"",option_choices:[],option_default:0,option_size:"default",option_select:"single"}:"comment"==e?{directions:""}:"input"==e?{directions:"",input_type:"decimal",input_max:99.99,input_min:-99.99,input_length:!1,input_length_int:4,input_length_dec:2,input_req:0,input_regex:"",input_size:"default",input_units:"inches"}:void 0},e.mode=e.task_id?"edit":"new","edit"==e.mode?o.getTaskById(e.task_id).then(function(t){e.task=t.data.results}):e.task=e.task_blank(),e.task_save=function(){var t={};angular.copy(e.task,t);var n=t.instructions.steps;for(var i in n)for(var s in n[i])delete n[i].$$hashKey,delete n[i].TempOpt;t.instructions=JSON.stringify({steps:n}),o.saveTask(t).success(function(t){e.ok()})},e.step_add=function(){e.task.instructions.steps.push({show:!0})},e.step_remove=function(t){window.confirm("Are you sure?\nThis will delete all parts of this step.")&&n(function(){e.task.instructions.steps.splice(t,1)},0,!0)},e.step_move=function(t,n){var i=t+n;if(e.task.instructions.steps.length>0&&i>=0&&i<e.task.instructions.steps.length){var o=e.task.instructions.steps[t],s=e.task.instructions.steps[i];e.task.instructions.steps[t]=s,e.task.instructions.steps[i]=o}},e.step_type_remove=function(e,t){window.confirm("Are you sure?\nThis will delete task type permanently.")&&n(function(){delete e[t]},0,!0)},e.step_type_new=function(t,n){t[n]=e.task_type_blank(n)},e.step_option_add=function(e){if(null!=e.optiontemp&&""!=e.optiontemp.trim()){var t=e.optiontemp;e.option.option_choices.push(t),e.optiontemp=""}},e.step_option_remove=function(e,t){window.confirm("Are you sure?")&&n(function(){e.option.option_choices.splice(t,1)},0,!0)},e.ok=function(){i.close("ok")},e.cancel=function(){i.dismiss("cancel")}});
//# sourceMappingURL=./formbuilder-min.js.map
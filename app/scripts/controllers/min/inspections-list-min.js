Modustri.controller("InspectionsListCtrl",["$log","$scope","$routeParams","$location","$modal","InsServices","UserServices","Utilities","MachineServices","CustomerServices","AuthServices","AppSettings",function(e,t,i,n,o,a,s,c,m,r,u,p){"use strict";function g(){var e=moment(t.sortFromDate).unix(),i=moment(t.sortToDate).unix();return e>i?(alert("From date cannot be later than To date"),!1):!0}u.checkUserCreds(),t.UserSettings=u.getUserSettings();var l="uiinspections",d=[],h;t.sortFromDate=localStorage.getItem("sortFromDate")||"",t.sortToDate=localStorage.getItem("sortToDate")||"";var b=i.page?i.page:1,f=function(){a.query(b).then(function(e){t.Inspections=e.data.results,t.pages=e.data.pages,t.paginationShow=t.pages>0?!0:!1;var i=Math.round((new Date).getTime()/1e3);_.each(t.Inspections,function(e,t,n){i-e.timestamp>2678400&&r.get(e.customer_id).then(function(t){var i=t.data.results;e.inspection_obj.customer=e.inspection_obj.customer||{},e.inspection_obj.customer.name=i.name,e.inspection_obj.customer.address=i.address,e.inspection_obj.customer.city=i.city,e.inspection_obj.customer.state=i.state,e.inspection_obj.customer.zip=i.zip,e.inspection_obj.customer.primary_contact_id=i.primary_contact_id}),e.datestring=c.getDatestring(e.timestamp),"machine"in e.inspection_obj&&(e.inspection_obj.machine.main_image_id!==!1&&0!==e.inspection_obj.machine.main_image_id&&"0"!==e.inspection_obj.machine.main_image_id?(e.inspection_obj.machine.img=p.BASE_URL+"imgtmb/"+e.inspection_obj.machine.main_image_id+"/",e.inspection_obj.machine.img_full=p.BASE_URL+"img/"+e.inspection_obj.machine.main_image_id+"/",h=setTimeout(function(){d[t]=document.createElement("img"),d[t].src=e.inspection_obj.machine.img_full},0)):m.get(e.machine_id).then(function(i){var n=i.data.results.main_image_id;""!==n&&n>0&&m.getPhoto(i.data.results.main_image_id).then(function(i){e.inspection_obj.machine.img=p.BASE_URL+"imgtmb/"+i.data.results.id+"/",e.inspection_obj.machine.img_full=p.BASE_URL+"img/"+i.data.results.id+"/",h=setTimeout(function(){d[t]=document.createElement("img"),d[t].src=e.inspection_obj.machine.img_full},0)})}),("(null)"===e.inspection_obj.machine.equipment_id||null===e.inspection_obj.machine.equipment_id)&&(e.inspection_obj.machine.equipment_id="N/A")),""!=e.inspection_obj.manufacturer.company&&e.inspection_obj.manufacturer.company||m.get(e.machine_id).then(function(t){m.getManufacturerById(t.data.results.manufacturer_id).then(function(t){e.inspection_obj.manufacturer.company=t.data.results.company})})})})},j=function(e){var i=c.getTimestamp(t.sortFromDate),n=c.getTimestamp(t.sortToDate);i-=21600,n+=64800,a.getByDateRange(e,i,n).then(function(e){t.Inspections=e.data.results,t.pages=e.data.pages,t.paginationShow=t.pages>0?!0:!1,_.each(t.Inspections,function(e,t,i){e.datestring=c.getDatestring(e.timestamp),"machine"in e.inspection_obj&&("(null)"===e.inspection_obj.machine.equipment_id&&(e.inspection_obj.machine.equipment_id="N/A"),e.inspection_obj.machine.main_image_id!==!1&&e.inspection_obj.machine.main_image_id>0&&(e.inspection_obj.machine.img=p.BASE_URL+"imgtmb/"+e.inspection_obj.machine.main_image_id+"/",e.inspection_obj.machine.img_full=p.BASE_URL+"/img/"+e.inspection_obj.machine.main_image_id+"/",d[t]=document.createElement("img"),d[t].src=e.inspection_obj.machine.img_full))})}),angular.element(".pagination-range").remove(),angular.element(".pagination").html("")};t.uiShow=function(e){return u.uiToggle(u.getUserLevel(),l,e)},t.clearDatePickers=function(){t.paginationShow=!0,localStorage.setItem("sortFromDate",""),localStorage.setItem("sortToDate",""),t.sortFromDate="",t.sortToDate="",n.path("/inspections/list/")},t.deleteInspection=function(e,i){confirm("Are you sure you want to delete this inspection?")&&a.del(e).then(function(e){t.Inspections.splice(i.$index,1),t.$emit("inspection_deleted",e)})},localStorage.getItem("sortFromDate")?j(b):f(),t.$watch("sortToDate",function(e,i){g()&&(localStorage.setItem("sortToDate",e),e!==i&&""!==t.sortFromDate&&(j(1),n.path("/inspections/list/")))}),t.$watch("sortFromDate",function(e,i){g()&&(localStorage.sortFromDate=e,e!==i&&""!==t.sortToDate&&(j(1),n.path("/inspections/list/")))}),t.img=null,t.open=function(e){t.img=e;var i=o.open({template:t.modal_html_template,controller:ModalInstanceCtrl,resolve:{img:function(){return t.img}}})}}]);var ModalInstanceCtrl=function(e,t,i){e.img=i,e.close=function(){t.dismiss("cancel")}};
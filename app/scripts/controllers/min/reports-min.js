Modustri.controller("ReportCtrl",["$log","$scope","$routeParams","$location","$http","CustomerServices","MachineServices","InsServices","UserServices","AuthServices","Utilities","AppSettings","$filter",function(t,e,a,n,r,o,i,s,c,l,h,p,u){"use strict";function d(t){t=new Date(t);var e=t.getDay(),a=t.getDate()-e+(0==e?-6:1);return new Date(t.setDate(a))}function f(t){return t=new Date(t),new Date(t.getFullYear(),t.getMonth(),1)}function m(t){return t=new Date(t),new Date(t.getFullYear(),t.getMonth()+1,1)}function g(t){return t=new Date(t),new Date(t.getFullYear(),0,1)}function y(){for(var t=[],a=0;a<=x();a++){var n=moment(e.fromChartDate).add("days",a).format("MM/DD/YYYY hh:mm a");t.push(n)}return t}function b(){for(var t=[],e=0;e<=x();e++)t.push(0);return t}function x(){var t=864e5,a=(new Date(e.toChartDate)-new Date(e.fromChartDate))/t;return a+1}function v(){var t=[];return angular.forEach(e.Chart.inspectors_list,function(e){t.push({name:e.name,y:0})}),t}function C(){var t=[];return angular.forEach(e.chartCustomers,function(e){t.push({name:e,y:0})}),t}function D(){var t=[];return angular.forEach(e.chartMachineTypes,function(e){""!=e&&t.push({name:e,y:0,cnt:0,rating:0})}),t}function M(){var t=[];return angular.forEach(e.chartMachines,function(e){t.push({name:e,type:"",y:0,cnt:0,rating:0,n:[],inspections:[],regInspections:[]})}),t}function E(){var t=[];return angular.forEach(e.chartDealers,function(a){var n=[];angular.forEach(e.chartWeekly,function(t){n.push({start:t.start,end:t.end,name:t.name,y:0})}),t.push({name:a,weeks:n,unix:[],y:0})}),t}function A(){var t=[];return angular.forEach(e.chartManufacturers,function(e){t.push({name:e,machines:[],y:0})}),t}function k(t,a){for(var n=0;n<e.machines.length;n++){var r=e.machines[n];if(r.manufacturer_id==t&&r.model==a){var o=r.type;return o}}}function I(t,e,a,n){var r="",o="";r=a>70?"_red":a>30?"_yellow":"_green";var i=k(t,e);return o="Excavator"==i?"Excavator"+r:"Bulldozer"+r,o+="_"+n,"url(images/icons/machines/"+o+".png)"}function w(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.type&&void 0!==t.type&&-1==e.indexOf(t.type)&&e.push(t.type)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function j(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.customer&&void 0!==t.inspection_obj.customer&&-1==e.indexOf(t.inspection_obj.customer.name)&&e.push(t.inspection_obj.customer.name)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function U(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.machine&&void 0!==t.inspection_obj.machine&&-1==e.indexOf(t.inspection_obj.machine.model)&&e.push(t.inspection_obj.machine.model)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function P(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.dealer&&t.completed&&void 0!==t.inspection_obj.dealer&&-1==e.indexOf(t.inspection_obj.dealer.name)&&""!=t.inspection_obj.dealer.name&&e.push(t.inspection_obj.dealer.name)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function F(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.user&&void 0!==t.inspection_obj.user&&-1==e.indexOf(t.inspection_obj.user.username)&&""!=t.inspection_obj.user.username&&e.push(t.inspection_obj.user.username)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function S(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.manufacturer&&void 0!==t.inspection_obj.manufacturer&&-1==e.indexOf(t.inspection_obj.manufacturer.company)&&e.push(t.inspection_obj.manufacturer.company)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function T(t){var e;return"undefined"!=typeof t&&null!==t&&"Hi"!==t&&"Lo"!==t&&"NA"!==t?parseFloat(t):void 0}l.checkUserCreds(),e.UserSettings=l.getUserSettings(),e.InspectionCache=!1,e.ulevel=l.getUserLevel(),e.Chart={date:"",timestamp:"",filter:"",from:0,to:99999999999,customer_name:"",customer_id:"",inspectors_list:[],inspections:{}},$("#spinner").show(),c.getUsersByDealer(function(t){angular.forEach(t.results,function(t,a){e.Chart.inspectors_list.push({name:t.username,id:t.id})})}),e.Chart.inspections={},e.dashboardCustomers=[],e.chartType="column",e.fromChartDate=moment().subtract("months",6).format("MM/DD/YYYY hh:mm a"),e.toChartDate=moment().format("MM/DD/YYYY hh:mm a"),e.UpdateDateRangeData=function(){$("#spinner").show(),e.showSpinner=!0,e.InspectionCache=!1,e.GetInspectionData()},e.UpdateDispatch=function(t){var a=t.data.results;_.each(t.data.results,function(t,e,n){a[e].datestring=moment.unix(t.timestamp).format("MM/DD/YYYY hh:mm a")}),e.Chart.inspections=a};var O=$("#total-inspections-chart"),Y=$("#total-customers-chart"),H=$("#total-machines-chart"),G=$("#machine-population-wear-chart"),W=$("#realtime-inspection-chart"),B=$("#wear-analysis-chart"),L=$("#inspection-gauge-monthly-chart"),N=$("#inspection-gauge-annual-chart"),R=$("#machine-population-chart"),J=$("#opportunities-converstions-chart"),V=$("#machine-cph-chart"),z=$("#dealer-total-chart"),K=$("#dealer-performance-chart"),X=$("#average-wear-chart"),Z=$("#undercarriage-brands-chart"),q=$("#machines-percentage-chart");e.chartDealers=[],e.chartCustomers=[],e.chartInspectors=[],e.chartMachines=[],e.chartMachineTypes=[],e.chartManufacturers=[],e.chartWeekly=[],e.chartMonthly=[],e.chartAnnual=[],e.machines=[],i.queryModels().then(function(t){e.machines=t.data.results,e.chartMachineTypes=w(t.data.results)}),e.GetInspectionData=function(){if($("#spinner").show(),e.fromUnix=moment(e.fromChartDate).unix(),e.toUnix=moment(e.toChartDate).unix(),e.fromUnix=e.fromUnix-21600,e.toUnix=e.toUnix+64800,e.InspectionCache){var t=e.InspectionCache;e.initializeChart(t),e.UpdateDispatch(t),e.UpdateInspectorChart(t),e.UpdateCustomerChart(t),e.UpdateMachineChart(t),e.UpdateMachinePopulationWearChart(t),e.UpdateRealtimeInspectionChart(t),e.UpdateWearAnalysisChart(t),e.UpdateInspectionGaugeChart(t),e.UpdateMachinePopulationChart(t),e.UpdateOpportunitiesConverstionsChart(t),e.UpdateMachineCphChart(t),e.UpdateDealerTotalChart(t),e.UpdateDealerPerformanceChart(t),e.UpdateAverageWearChart(t),e.UndercarriageBrandsChart(t),e.MachinesPercentageChart(t)}else s.getByDealerIdStartEnd(l.getDealerID(),e.fromUnix,e.toUnix).then(function(t){e.InspectionCache=t,e.initializeChart(t),e.UpdateDispatch(t),e.UpdateInspectorChart(t),e.UpdateCustomerChart(t),e.UpdateMachineChart(t),e.UpdateMachinePopulationWearChart(t),e.UpdateRealtimeInspectionChart(t),e.UpdateWearAnalysisChart(t),e.UpdateInspectionGaugeChart(t),e.UpdateMachinePopulationChart(t),e.UpdateOpportunitiesConverstionsChart(t),e.UpdateMachineCphChart(t),e.UpdateDealerTotalChart(t),e.UpdateDealerPerformanceChart(t),e.UpdateAverageWearChart(t),e.UndercarriageBrandsChart(t),e.MachinesPercentageChart(t)})},e.initializeChart=function(t){e.chartCustomers=j(t.data.results),e.chartMachines=U(t.data.results),e.chartDealers=P(t.data.results),e.chartInspectors=F(t.data.results),e.chartManufacturers=S(t.data.results);for(var a=moment(e.fromUnix,"X").format("YYYY-MM-DD"),n=moment(e.toUnix,"X").format("YYYY-MM-DD"),r=moment.twix(d(new Date(a)),new Date(n)).iterate("weeks"),o=null,i=null;r.hasNext();)i=r.next(),null!=o&&e.chartWeekly.push({start:o.unix(),end:i.unix()-1,name:o.format("Wo YYYY")}),o=i;e.chartWeekly.push({start:o,end:e.toUnix,name:o.format("Wo YYYY")});for(var r=moment.twix(f(new Date(a)),m(new Date(n))).iterate("months"),o=null,i=null;r.hasNext();)i=r.next(),null!=o&&e.chartMonthly.push({start:o.unix(),end:i.unix()-1,name:o.format("YYYY-M"),value:0,total:0}),o=i;for(var s=new Date(a),c=new Date(n),l=s.getFullYear();l<=c.getFullYear();l++)e.chartAnnual.push({name:l,value:0,total:0})},e.UpdateInspectorChart=function(t){var a=y(),n=v(),r=t.data.results;r=void 0===e.inspectorChartSearchFilter||null===e.inspectorChartSearchFilter?u("filter")(t.data.results,{}):u("filter")(t.data.results,{inspection_obj:{user:{username:e.inspectorChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.user){var e=t.inspection_obj.user.username;angular.forEach(n,function(t){t.name===e&&t.y++})}});var o=[],i=[];angular.forEach(n,function(t){t.y>0&&(o.push(t.name),i.push(t.y))});var s=1,c=25;i.length>c&&(s=Math.round(i.length/c)),O.highcharts({chart:{type:e.chartType},title:{text:"Inspections by PSSR"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:"<table>",pointFormat:'<tr><td style="color:{point.color};padding:0">{point.category}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y}"}}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Inspectors",data:i}]})},e.UpdateCustomerChart=function(t){var a=y(),n=C(),r=t.data.results;r=void 0===e.customerChartSearchFilter||null===e.customerChartSearchFilter?u("filter")(r,{}):u("filter")(r,{inspection_obj:{customer:{name:e.customerChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.customer&&t.completed){var e=t.inspection_obj.customer.name,a=t.inspection_obj.customer.id,r=a;angular.forEach(n,function(t){t.url=void 0!==a&&null!==a?r:"WTF",t.name===e&&t.y++})}});var o=[],i=[];angular.forEach(n,function(t){t.y>=1&&(o.push(t.name),i.push(t.y))});var s=1,c=25;i.length>c&&(s=Math.round(i.length/c)),Y.highcharts({chart:{type:e.chartType},title:{text:"Inspections by Customer"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:"<table>",pointFormat:'<tr><td style="color:{point.color};padding:0">{point.category}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y}"}}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Customers",data:i}]})},e.UpdateMachineChart=function(t){var a=y(),n=M(),r=t.data.results;r=void 0===e.machineChartSearchFilter||null===e.machineChartSearchFilter?u("filter")(r,{}):u("filter")(r,{inspection_obj:{machine:{model:e.machineChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.machine){var e=[];angular.forEach(t.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var a=0;a<t.length;a++)e.push(T(t[a].left.percentage)),e.push(T(t[a].right.percentage))});var a=e.sort(function(t,e){return e-t});if("undefined"!=typeof a[0]&&a[0]>69){var r=t.inspection_obj.machine.model;angular.forEach(n,function(t){t.name===r&&t.y++})}}});var o=[],i=[];angular.forEach(n,function(t){t.y>=1&&(o.push(t.name),i.push(t.y))});var s=1,c=25;i.length>c&&(s=Math.round(i.length/c)),H.highcharts({chart:{type:e.chartType},title:{text:"Machines above 70% By Model"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:"<table>",pointFormat:'<tr><td style="color:{series.color};padding:0">{point.category}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y}"}}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Machines",data:i}]}),$("#spinner").hide()},e.UpdateDealerTotalChart=function(t){var a=y(),n=E(),r=t.data.results;angular.forEach(r,function(t){if(void 0!==t.inspection_obj.dealer){var e=t.inspection_obj.dealer.name,a=t.inspection_obj.dealer.id,r=t.modified;angular.forEach(n,function(t){t.name===e&&t.y++})}});var o=[],i=[];angular.forEach(n,function(t){if(t.y>0){switch(t.name){case"AgentX":t.name="NDUSTRIALIZADORA DANAMEX S.A";break;case"Altorfer":t.name="KOKUKA SHOKAI CO.,LTD";break;case"MacAllister":t.name="VOIGT WERKZEUGMASCHINEN";break;case"Ziegler":t.name="PERFECBORE LTD.";break;case"H.O.Penn":t.name="MENDHAM MACHINERY PTY. LTD.";break;case"Patten Cat":t.name="SUBRA DO BRASIL";break;case"Warren Cat":t.name="A.R.A. SRL";break;case"Empire Cat":t.name="";break;case"Thompson Machinery Cat":t.name=""}""!==t.name&&(o.push(t.name),i.push(t.y))}});var s=1,c=25;i.length>c&&(s=Math.round(i.length/c)),z.highcharts({chart:{type:e.chartType},title:{text:"Total Inspections per Dealer"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:"<table>",pointFormat:'<tr><td style="color:{point.color};padding:0">{point.category}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!0,format:"{point.y}"}}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Dealers",data:i}]})},e.UpdateMachinePopulationWearChart=function(t){var a=y(),n=M(),r=t.data.results;angular.forEach(r,function(t){if(void 0!==t.inspection_obj.machine){var e=[];angular.forEach(t.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var a=0;a<t.length;a++)e.push(T(t[a].left.percentage)),e.push(T(t[a].right.percentage))});var a=e.sort(function(t,e){return e-t});if("undefined"!=typeof a[0]&&!isNaN(a[0])){var r=t.inspection_obj.machine.model;angular.forEach(n,function(e){e.name===r&&(e.y++,e.rating+=a[0],e.cnt++,e.type=k(t.inspection_obj.machine.manufacturer_id,t.inspection_obj.machine.model))})}}});var o=[],i=[],s=[],c=[];angular.forEach(n,function(t){var a=0;t.cnt>2&&(a=parseFloat((t.rating/t.cnt).toFixed(2))),t.rating=a,t.y>0&&a>0&&(t.index=e.chartMachineTypes.indexOf(t.type),c.push(t))}),c.sort(function(t,e){return t.index-e.index||t.y-e.y}),angular.forEach(c,function(t){o.push(t.name),i.push(t.y),s.push(t.rating)});var l=1,h=25;i.length>h&&(l=Math.round(i.length/h)),G.highcharts({title:{text:"Machine population vs Wear"},xAxis:{categories:o,labels:{rotation:90,align:"left"}},yAxis:[{labels:{style:{color:"black"}},title:{text:"Average % wear",style:{color:"black"}}},{title:{text:"Machine size",style:{color:"black"}},labels:{style:{color:"black"}},opposite:!0}],tooltip:{shared:!0},legend:{enabled:!0},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"% Wear",type:"column",yAxis:1,data:s},{name:"# Machines",type:"spline",data:i}]})},e.UpdateRealtimeInspectionChart=function(t){var e=0,a=[],n=moment().add("months",-1).unix(),r=moment().unix(),o=3600;n-=n%o,r-=r%o;var i=[];s.getByDealerIdStartEnd(l.getDealerID(),n,r).then(function(t){var o=t.data.results,c=10;for(o.length<10&&(c=o.length),e=0;c>e;e++){var h=o[e],p=[];angular.forEach(h.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var e=0;e<t.length;e++)p.push(T(t[e].left.percentage)),p.push(T(t[e].right.percentage))});var u=p.sort(function(t,e){return e-t}),d="",f="",m=0;void 0!==h.inspection_obj.machine&&(d=h.inspection_obj.machine.model),void 0!==h.inspection_obj.dealer&&(f=h.inspection_obj.dealer.name),"undefined"==typeof u[0]||isNaN(u[0])||(m=u[0]),a.push({y:m,machine:d,dealer:f,marker:{symbol:I(h.inspection_obj.machine.manufacturer_id,h.inspection_obj.machine.model,m,"n")}}),i.push(Highcharts.dateFormat("%Y-%m-%d %H:%M %p",1e3*h.timestamp))}a.reverse(),i.reverse(),Highcharts.setOptions({global:{useUTC:!1}}),W.highcharts({chart:{type:"spline",events:{load:function(){var t=this.series[0],a=this.axes[0];setInterval(function(){n=r+60,r=n+60;var o=0;s.getByDealerIdStartEnd(l.getDealerID(),n,r).then(function(n){var r=n.data.results;for(r.reverse(),e=0;e<r.length;e++){var o=r[e],s=[];angular.forEach(o.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var e=0;e<t.length;e++)s.push(T(t[e].left.percentage)),s.push(T(t[e].right.percentage))});var c=s.sort(function(t,e){return e-t}),l="",h="",p=0;void 0!==o.inspection_obj.machine&&(l=o.inspection_obj.machine.model),void 0!==o.inspection_obj.dealer&&(h=o.inspection_obj.dealer.name),"undefined"==typeof c[0]||isNaN(c[0])||(p=c[0]),i.push(Highcharts.dateFormat("%Y-%m-%d %H:%M %p",1e3*o.timestamp)),a.setCategories(i,!1);var u={y:p,machine:l,dealer:h,marker:{symbol:I(o.inspection_obj.machine.manufacturer_id,o.inspection_obj.machine.model,p,"n")}};t.addPoint(u,!0,!0)}})},6e4)}}},title:{text:"Real Time Inspection Tracker"},xAxis:{categories:i},yAxis:{title:{text:"% worn"},min:0,max:120,plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{formatter:function(){return""!=this.point.options.dealer?this.point.options.dealer+"<br/>"+this.point.options.machine+"<br/>"+this.y+"% worn<br/>"+this.x:this.point.options.machine+"<br/>"+this.y+"% worn<br/>"+this.x}},legend:{enabled:!1},exporting:{enabled:!1},series:[{name:"Inspection",data:a}]})})},e.UpdateWearAnalysisChart=function(t){var e=y(),a=M(),n=[],r=t.data.results;angular.forEach(r,function(t){if(void 0!==t.inspection_obj.machine){var e=[];angular.forEach(t.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var a=0;a<t.length;a++)e.push(T(t[a].left.percentage)),e.push(T(t[a].right.percentage))});var n=e.sort(function(t,e){return e-t});if("undefined"!=typeof n[0]&&!isNaN(n[0])){var r=t.inspection_obj.machine.model;angular.forEach(a,function(e){if(e.name===r){var a=t.inspection_obj.hour_meter_reading;a>0&&n[0]>0&&15e3>a&&(500>a&&n[0]<30||a>500&&1e3>a&&n[0]<50||a>1e3&&2e3>a&&n[0]<80||a>2e3&&3e3>a||a>3e3&&7e3>a&&n[0]<=80||a>7e3&&8e3>a&&n[0]<=120)&&e.regInspections.push({x:a,y:n[0],marker:{symbol:I(t.inspection_obj.machine.manufacturer_id,t.inspection_obj.machine.model,n[0],"s")}})}})}}});var o=[];angular.forEach(a,function(t){t.regInspections.length>0&&(o=o.concat(t.regInspections))}),B.highcharts({chart:{type:"scatter"},title:{text:"Life-cycle wear analysis"},xAxis:{title:{enabled:!0,text:"Hours on machine"},startOnTick:!0,endOnTick:!0,showLastLabel:!0,min:0},yAxis:{min:0,max:120,title:{text:"% worn"}},legend:{enabled:!1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}},tooltip:{headerFormat:"<b>{series.name}</b><br>",pointFormat:"hours: {point.x}, % worn: {point.y}"}}},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{regression:!0,regressionSettings:{type:"linear"},name:"Inspection",data:o}]})},e.UpdateInspectionGaugeChart=function(t){angular.forEach(e.chartMonthly,function(t){t.value=0,t.total=0}),angular.forEach(e.chartAnnual,function(t){t.value=0,t.total=0});var a=t.data.results;angular.forEach(a,function(t){var a=t.modified;angular.forEach(e.chartMonthly,function(e){e.start<=a&&a<=e.end&&(e.total++,t.completed&&e.value++)}),angular.forEach(e.chartAnnual,function(e){var n=new Date(1e3*a);n.getFullYear()==e.name&&(e.total++,t.completed&&e.value++)})});var n=0,r=0,o=0,i=0;angular.forEach(e.chartMonthly,function(t){n+=t.value,r+=t.total}),n=parseInt(n/e.chartMonthly.length),r=parseInt(r/e.chartMonthly.length),angular.forEach(e.chartAnnual,function(t){o+=t.value,i+=t.total}),o=parseInt(o/e.chartAnnual.length),i=parseInt(i/e.chartAnnual.length);var s={chart:{type:"solidgauge"},title:null,pane:{center:["50%","85%"],size:"140%",startAngle:-90,endAngle:90,background:{backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"#EEE",innerRadius:"60%",outerRadius:"100%",shape:"arc"}},tooltip:{enabled:!1},yAxis:{stops:[[.1,"#55BF3B"],[.5,"#DDDF0D"],[.9,"#DF5353"]],lineWidth:0,minorTickInterval:"auto",tickPixelInterval:400,tickWidth:0,title:{y:-70},labels:{y:16,style:{fontSize:"18px"}}},plotOptions:{solidgauge:{dataLabels:{y:5,borderWidth:0,useHTML:!0}}}};L.highcharts(Highcharts.merge(s,{yAxis:{min:0,max:r,tickInterval:r/2,title:{text:""}},credits:{enabled:!1},series:[{name:"Monthly Inspection",data:[n],dataLabels:{format:'<div style="text-align:center;margin-top:20px;"><span style="font-size:24px;color:'+(Highcharts.theme&&Highcharts.theme.contrastTextColor||"black")+'">{y}</span><br/><span style="font-size:12px;color:silver">MTD Inspections</span></div>'},tooltip:{valueSuffix:" Monthly"}}]})),N.highcharts(Highcharts.merge(s,{yAxis:{min:0,max:i,tickInterval:i/2,title:{text:""}},series:[{name:"Annual Inspection",data:[o],dataLabels:{format:'<div style="text-align:center;margin-top:20px;"><span style="font-size:24px;color:'+(Highcharts.theme&&Highcharts.theme.contrastTextColor||"black")+'">{y}</span><br/><span style="font-size:12px;color:silver">YTD Inspections</span></div>'},tooltip:{valueSuffix:" Annual"}}]}))},e.UpdateMachinePopulationChart=function(t){var a=Highcharts.getOptions().colors,n=[];angular.forEach(e.chartManufacturers,function(t,r){n.push({name:t,y:0,color:a[r],drilldown:{name:t,machineTypes:[],data:[]}}),angular.forEach(e.chartMachineTypes,function(t){""!=t&&(n[r].drilldown.machineTypes.push(t),n[r].drilldown.data.push(0))})});var r=t.data.results,o=0;angular.forEach(r,function(t){if(void 0!==t.inspection_obj.manufacturer&&void 0!==t.inspection_obj.machine){var e=t.inspection_obj.manufacturer,a=t.inspection_obj.machine;angular.forEach(n,function(t){t.name===e.company&&angular.forEach(t.drilldown.machineTypes,function(n,r){k(e.id,a.model)==n&&(o++,t.y++,t.drilldown.data[r]++,"Caterpillar"!=t.name&&(o+=30,t.y=t.y+30,t.drilldown.data[r]=t.drilldown.data[r]+30))})})}});var i,s,c=[],l=[],h,p;s=n.length;for(var u=0;s>u;u+=1)if(n[u].y>0){c.push({name:n[u].name,y:n[u].y,percent:0,color:n[u].color}),c[c.length-1].percent=Math.round(n[u].y/o*100*100)/100,h=n[u].drilldown.data.length;for(var d=0;h>d;d+=1)p=.2-d/h/5,n[u].drilldown.data[d]>0&&(l.push({name:n[u].drilldown.machineTypes[d],y:n[u].drilldown.data[d],percent:0,color:Highcharts.Color(n[u].color).brighten(p).get()}),l[l.length-1].percent=Math.round(n[u].drilldown.data[d]/n[u].y*100*100)/100)}R.highcharts({chart:{type:"pie"},title:{text:"Machine Population"},yAxis:{title:{text:"Total percent machine population"}},plotOptions:{pie:{shadow:!1,center:["50%","50%"]}},tooltip:{formatter:function(){var t=this.point.percent;return"<b>"+this.point.name+"</b>: "+t+"%"}},series:[{name:"Manufacturers",data:c,size:"80%",dataLabels:{formatter:function(){var t=this.point.percent;return t>5?"<b>"+this.point.name+"</b><br/>("+t+"%)":null},color:"white",align:"center",distance:-50}},{name:"MachineTypes",data:l,size:"100%",innerSize:"80%",dataLabels:{formatter:function(){var t=this.point.percent;return t>1?"<b>"+this.point.name+":</b> "+t+"%":null}}}]})},e.UpdateOpportunitiesConverstionsChart=function(t){var a=[];angular.forEach(e.chartInspectors,function(t,e){a.push({name:t,total:0,opportunities:0,quotes:0,parts:0,services:0})});var n=t.data.results,r=0;angular.forEach(n,function(t){if(void 0!==t.inspection_obj.user&&null!=t.inspection_obj.user){var e=t.inspection_obj.user;angular.forEach(a,function(t){if(t.name===e.username){var a=0,n=0,r=0,o=0;a=Math.round(Math.random()),1==a&&(n=Math.round(Math.random()),1==n&&(r=Math.round(Math.random()),o=Math.round(Math.random()))),t.total++,t.opportunities=t.opportunities+a,t.quotes=t.quotes+n,t.parts=t.parts+r,t.services=t.services+o}})}}),a.sort(function(t,e){return e.total-t.total});var o=[],i=[];i.push({name:"Opportunities",data:[],color:"#178BA2",stack:"bar1"}),i.push({name:"Quotes",data:[],color:"#F38435",stack:"bar1"}),i.push({name:"Parts Tickets",data:[],color:"#7DC44E",stack:"bar2"}),i.push({name:"Service Tickets",data:[],color:"#6059A5",stack:"bar3"}),angular.forEach(a,function(t){if(t.opportunities>0&&t.total>5){if(t.name.indexOf("@")>0&&(t.name=t.name.substring(0,t.name.indexOf("@"))),t.name.indexOf(" ")>0){var e=t.name.match(/\b(\w)/g),a=e.join("").toUpperCase();o.push(a)}else o.push(t.name);var n=0,r=0,s=0,c=0;n=Math.round(t.opportunities/t.total*100*100)/100,r=Math.round(t.quotes/t.total*100*100)/100,s=Math.round(t.parts/t.total*100*100)/100,c=Math.round(t.services/t.total*100*100)/100,i[0].data.push({y:n-r,insp_total:t.total}),i[1].data.push({y:r,insp_total:t.total}),i[2].data.push({y:s,insp_total:t.total}),i[3].data.push({y:c,insp_total:t.total})}});var s=1,c=25;o.length>c&&(s=Math.round(o.length/c)),J.highcharts({chart:{type:"column"},title:{text:"OPPORTUNITIES & CONVERSTIONS"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{allowDecimals:!1,min:0,max:100,title:{text:"% of Inspections"},labels:{format:"{value}%"}},tooltip:{formatter:function(){return"Opportunities"==this.series.name?"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.point.stackTotal+"%<br/>Total Inspections: "+this.point.insp_total:"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y+"%<br/>Total Inspections: "+this.point.insp_total}},plotOptions:{column:{stacking:"normal"}},series:i})},e.UpdateMachineCphChart=function(t){var a=[];angular.forEach(e.chartMachines,function(t){"(null)"!=t&&a.push({name:t,m_cph:0,c_cph:0,total:0})});var n=t.data.results;angular.forEach(n,function(t){if(void 0!==t.inspection_obj.machine){var e=t.inspection_obj.machine.model;angular.forEach(a,function(t){t.name===e&&t.total++})}}),angular.forEach(a,function(t){t.m_cph=parseFloat((10*Math.random()).toFixed(2)),t.c_cph=parseFloat((10*Math.random()).toFixed(2))});var r=[],o=[{name:"Regional Machine CPH",color:"#56C6D2",data:[]},{name:"Customer XYZ Machine CPH",color:"#2E3192",data:[]}];angular.forEach(a,function(t){if(t.total>1&&t.m_cph>1&&t.c_cph>1&&t.m_cph<5&&t.c_cph<5){r.push(t.name);var e=0,a=0,n=Math.round(100*Math.random());if(e=parseInt(t.total*n/100),0==e&&(e=1),a=t.total-e,a>e){var i=e;e=a,a=i}1==e&&(e=parseInt(e*Math.random()*20)),o[0].data.push({y:-1*t.m_cph,insp_total:e}),o[1].data.push({y:t.c_cph,insp_total:a})}});var i=1,s=20;r.length>s&&(i=Math.round(r.length/s)),V.highcharts({chart:{type:"bar"},title:{text:"AVERAGE CPH PER MACHINE VS CUSTOMER XYZ CPH"},xAxis:[{categories:r,reversed:!1,labels:{step:i}},{opposite:!0,reversed:!1,categories:r,linkedTo:0,labels:{step:i}}],yAxis:{title:{text:null},labels:{formatter:function(){return"$"+Math.abs(this.value)}},min:-5,max:5},plotOptions:{series:{stacking:"normal",dataLabels:{enabled:!0,inside:!1,formatter:function(){return this.point.insp_total}}}},tooltip:{formatter:function(){return"<b>"+this.key+"</b>: $"+Highcharts.numberFormat(Math.abs(this.point.y),2)}},series:o})},e.UpdateDealerPerformanceChart=function(t){var a=y(),n=E(),r=t.data.results;angular.forEach(r,function(t){if(void 0!==t.inspection_obj.dealer&&t.completed){var e=t.inspection_obj.dealer.name,a=t.inspection_obj.dealer.id,r=t.modified;angular.forEach(n,function(t){t.name===e&&angular.forEach(t.weeks,function(t){t.start<=r&&r<=t.end&&t.y++})})}});var o=[];angular.forEach(e.chartWeekly,function(t){o.push(t.name)});var i=[];angular.forEach(n,function(t){switch(t.name){case"AgentX":t.name="NDUSTRIALIZADORA DANAMEX S.A";break;case"Altorfer":t.name="KOKUKA SHOKAI CO.,LTD";break;case"MacAllister":t.name="VOIGT WERKZEUGMASCHINEN";break;case"Ziegler":t.name="PERFECBORE LTD.";break;case"H.O.Penn":t.name="MENDHAM MACHINERY PTY. LTD.";break;case"Patten Cat":t.name="SUBRA DO BRASIL";break;case"Warren Cat":t.name="A.R.A. SRL";break;case"Empire Cat":t.name="";break;case"Thompson Machinery Cat":t.name=""}if(""!==t.name){var e={name:t.name,data:[]};angular.forEach(t.weeks,function(t){e.data.push(t.y)}),i.push(e)}});var s=1,c=25;i.length>c&&(s=Math.round(i.length/c)),K.highcharts({chart:{type:"spline"},title:{text:"Dealer Performance"},xAxis:{categories:o,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:i})},e.UpdateAverageWearChart=function(t){var e=y(),a=M(),n=t.data.results;n=u("orderBy")(n,"-timestamp"),angular.forEach(n,function(t){if(void 0!==t.inspection_obj.machine&&t.completed){var e=[];angular.forEach(t.inspection_obj.results,function(t){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var a=0;a<t.length;a++)e.push(T(t[a].left.percentage)),e.push(T(t[a].right.percentage))});var n=e.sort(function(t,e){return e-t});if("undefined"!=typeof n[0]&&!isNaN(n[0])){var r=t.inspection_obj.machine.model;angular.forEach(a,function(e){e.name===r&&e.inspections.length<2&&e.inspections.push({hour_meter_reading:t.inspection_obj.hour_meter_reading,rating:n[0]})})}}});var r=[],o=[];angular.forEach(a,function(t){if(2==t.inspections.length){r.push(t.name);var e=parseFloat(((t.inspections[0].hour_meter_reading-t.inspections[1].hour_meter_reading)*((t.inspections[0].rating-t.inspections[1].rating)/100)).toFixed(2));e>4e3&&(t.y=e,o.push(t.y))}});var i=1,s=25;o.length>s&&(i=Math.round(o.length/s)),X.highcharts({chart:{type:"column"},title:{text:"Average Hours of Machine Undercarriage"},xAxis:{categories:r,labels:{rotation:90,align:"left"}},yAxis:{title:{text:"Average Hours"}},tooltip:{headerFormat:"<table>",pointFormat:'<tr><td style="color:{series.color};padding:0">{point.category}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0},series:{borderWidth:0,dataLabels:{enabled:!1,format:"{point.y}"}}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})
},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Machines",data:o}]}),$("#spinner").hide()},e.UndercarriageBrandsChart=function(t){var e=y(),a=A(),n=t.data.results;angular.forEach(n,function(t){if(void 0!==t.inspection_obj.manufacturer&&void 0!==t.inspection_obj.machine){var e=t.inspection_obj.machine,n=t.inspection_obj.manufacturer;angular.forEach(a,function(t){t.name===n.company&&-1==t.machines.indexOf(e.model)&&(t.machines.push(e.model),t.y++)})}});var r=[];angular.forEach(a,function(t){t.y>0&&r.push({name:t.name,y:t.y})}),Z.highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:1,plotShadow:!1},title:{text:"Undercarriage Brands"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{type:"pie",name:"Undercarriage Brands",data:r}]})},e.MachinesPercentageChart=function(t){var e=y(),a=M(),n=t.data.results;angular.forEach(n,function(t){if(void 0!==t.inspection_obj.machine){var e=t.inspection_obj.machine.model;angular.forEach(a,function(a){a.name===e&&(t.completed?a.y++:a.n++)})}});var r=[],o=[],i=[];angular.forEach(a,function(t){(t.y>0||t.n>0)&&t.y>=1&&(r.push(t.name),o.push(t.y),i.push(t.n))});var s=1,c=25;o.length>c&&(s=Math.round(o.length/c)),q.highcharts({chart:{type:"column"},title:{text:"Percentage of Machines Inspected"},xAxis:{categories:r,labels:{rotation:90,step:s,align:"left"}},yAxis:{min:0,title:{text:"Number of Inspections"},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},tooltip:{formatter:function(){return"<b>"+this.x+"</b>: "+this.y}},plotOptions:{column:{stacking:"normal",pointPadding:.2,borderWidth:0}},legend:{enabled:!1},exporting:{buttons:{contextButton:{menuItems:[{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download JPG",onclick:function(){this.exportChart({type:"image/JPEG"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1}]}}},series:[{name:"Total",data:i},{name:"Completed",data:o}]})},e.GetInspectionData(),e.selectedChartByInspector=function(){e.filterChartByInspector=null===e.inspectorChartSearchFilter?{}:{inspection_obj:{user:{username:e.inspectorChartSearchFilter}}}},e.selectedChartByCustomer=function(){e.filterChartByCustomer=null===e.customerChartSearchFilter?{}:{inspection_obj:{customer:{name:e.customerChartSearchFilter}}}}}]);
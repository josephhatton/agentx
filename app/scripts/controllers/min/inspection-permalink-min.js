Modustri.controller("InspectionPermalinkCtrl",["$scope","$q","$http","InsServices","Utilities","AppSettings","MachineServices","CustomerServices","AuthServices","UserServices","DealerServices","$routeParams",function(e,t,n,s,i,r,o,a,c,l,u,p){"use strict";e.UserSettings=c.getUserSettings();var m="uiinspections",d=c.getDealerID();u.getDealerImg(d).then(function(e){if("image_id"in e.data.results&&null!==e.data.results.obj&&null!==e.data.results.image_id){var t=r.BASE_URL+"img/"+e.data.results.image_id+"/";$("#logo").css("background-image","url("+t+")").css("width","250px"),$(".logo-wrapper").css("width","250px")}}),e.uiShow=function(e){return c.uiToggle(c.getUserLevel(),m,e)},e.state=null,e.is_latest_ins=!1,e.Components={},e.Measureable_parts=[],e.Tools=[],e.Summaries=[],e.Prev_ins={},e.condition_class=function(e,t){var n=e;return"left"===t&&(n+=" left-percentage"),"right"===t&&(n+=" right-percentage"),n};var g=function(){l.query().then(function(t){var n=t.results,s=_.where(n,{id:e.Ins.user_id});s[0]&&(e.Ins.inspection_obj.inspector=s[0].username),e.UserList=n})},h=function(){var t,n="";o.getComponentsByMachineModel(e.Ins.inspection_obj.machine.model_id,function(s){e.Components=[],t=s.results;for(var r=0;r<t.length;r++)t[r].hasOwnProperty("component_id")&&o.createComponentObj(e,t[r].component_id).then(function(t){n=i.snakeCase(t.type),"idlers"===n&&(e.Components.idlers_front||(e.Components.idlers_front=[]),e.Components.idlers_front.push(t),e.Components.idlers_rear||(e.Components.idlers_rear=[]),e.Components.idlers_rear.push(t)),"idlers"!==n&&(e.Components[n]||(e.Components[n]=[]),e.Components[n].push(t))})})};s.getForPermalink(p.hash).then(function(t){e.Ins=t.data.results,e.Measureable_parts=[];var n={};"results"in e.Ins.inspection_obj==!1&&(e.Ins.inspection_obj.results={}),s.getByMachineId(e.Ins.machine_id).then(function(t){e.Prev_ins=t.data.results,e.Prev_ins.length>0?(e.Prev_ins.sort(function(e,t){return parseInt(e.timestamp,10)<parseInt(t.timestamp,10)?1:parseInt(e.timestamp,10)>parseInt(t.timestamp,10)?-1:parseInt(e.timestamp,10)===parseInt(t.timestamp,10)?0:void 0}),e.Ins.timestamp===e.Prev_ins[0].timestamp&&(e.is_latest_ins=!0),e.Prev_ins=e.Prev_ins[1]):e.Prev_ins=!1,s.getFailureDates(e),s.buildSummariesTable(e)}),s.cleanUpNulls(e),e.Ins.datestring=i.getDatestring(e.Ins.timestamp),e.Ins.dealer_id=c.getDealerID(),s.setMainPhoto(e),u.getDealerImg(d).then(function(t){e.Ins.dealer_img_url="image_id"in t.data.results&&null!==t.data.results.obj?r.BASE_URL+"img/"+t.data.results.image_id+"/":!1}),_.each(e.Ins.inspection_obj.results,function(e,t,n){e.hasOwnProperty("model_id")&&e.model_id||"undefined"!=typeof e[0]&&e[0].hasOwnProperty("left")&&(e.model_id=e[0].left.id||e[0].right.id),_.each(e,function(e,i,r){s.setCondition(n,t,i)})}),o.getInspectionPhotos(e.Ins.id).then(function(t){s.renderInspectionPhotos(e,t)}),h(),g(),n=e.Ins.inspection_obj.results,o.getComponentTypesMachineNames().then(function(t){e.Measureable_parts=t,angular.forEach(n,function(t,i){_.contains(e.Measureable_parts,i)&&angular.forEach(n[i],function(t,r){s.setMeasurementToolNames(e,n[i][r]),s.setComponentDescription(n[i][r])})}),console.log("the inspection:"),console.dir(e.Ins)}),a.get(e.Ins.customer_id).then(function(t){var n=t.data.results;e.Ins.inspection_obj.customer.name=n.name,e.Ins.inspection_obj.customer.address=n.address,e.Ins.inspection_obj.customer.city=n.city,e.Ins.inspection_obj.customer.state=n.state,e.Ins.inspection_obj.customer.zip=n.zip,e.Ins.inspection_obj.customer.primary_contact_id=n.primary_contact_id})})}]);
Modustri.controller("DrilldownCtrl",["$log","$scope","$routeParams","$location","$http","CustomerServices","MachineServices","InsServices","UserServices","AuthServices","Utilities","AppSettings","$filter",function(t,e,a,n,r,o,i,s,c,m,l,h,u){"use strict";function d(){for(var t=[],a=0;a<=f();a++){var n=moment(new Date(e.fromChartDate)).add(a,"days").format("MM/DD/YYYY");t.push(n)}return t}function p(){for(var t=[],e=0;e<=f();e++)t.push(0);return t}function f(){var t=864e5,a=(new Date(e.toChartDate)-new Date(e.fromChartDate))/t;return a+1}function D(){var t=[];return angular.forEach(e.Chart.inspectors_list,function(e){t.push({name:e.name,data:p()})}),t}function C(){var t=[];return angular.forEach(e.chartCustomers,function(e){t.push({name:e,data:p()})}),t}function g(){var t=[];return angular.forEach(e.chartMachines,function(e){t.push({name:e,data:p()})}),t}function x(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.customer&&void 0!==t.inspection_obj.customer&&-1==e.indexOf(t.inspection_obj.customer.name)&&e.push(t.inspection_obj.customer.name)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}function y(t){var e=[],a=[];return angular.forEach(t,function(t){null!==t.inspection_obj.machine&&void 0!==t.inspection_obj.machine&&-1==e.indexOf(t.inspection_obj.machine.model)&&e.push(t.inspection_obj.machine.model)}),$.each(e,function(t,e){-1===$.inArray(e,a)&&a.push(e)}),a}m.checkUserCreds(),e.UserSettings=m.getUserSettings(),e.Chart={date:"",timestamp:"",filter:"",from:0,to:99999999999,customer_name:"",customer_id:"",inspectors_list:[],inspections:{}},$("#spinner").hide(),c.getUsersByDealer(function(t){angular.forEach(t.results,function(t,a){e.Chart.inspectors_list.push({name:t.username,id:t.id})})}),e.Chart.inspections={},e.dashboardCustomers=[],e.chartType="column",e.fromChartDate=moment().subtract(7,"days").format("MM/DD/YYYY"),e.toChartDate=moment().format("MM/DD/YYYY"),e.UpdateDateRangeData=function(){$("#spinner").show(),e.showSpinner=!0,e.UpdateDispatch(),e.UpdateInspectorChart(),e.UpdateCustomerChart(),e.UpdateMachineChart()},e.UpdateDispatch=function(){e.fromUnix=moment(new Date(e.fromChartDate)).unix(),e.toUnix=moment(new Date(e.toChartDate)).unix(),s.getByDealerIdStartEnd(m.getDealerID(),e.fromUnix,e.toUnix).then(function(t){var a=t.data.results;_.each(t.data.results,function(t,e,n){a[e].datestring=l.getDatestring(t.timestamp)}),e.Chart.inspections=a})},e.UpdateDispatch();var b=$("#total-inspections-chart"),Y=$("#total-customers-chart"),v=$("#total-machines-chart"),M=$("#drilldown-chart");e.chartCustomers=[],e.chartMachines=[],e.UpdateInspectorChart=function(){e.fromUnix=moment(new Date(e.fromChartDate)).unix(),e.toUnix=moment(new Date(e.toChartDate)).unix(),s.getByDealerIdStartEnd(m.getDealerID(),e.fromUnix,e.toUnix).then(function(t){var a=d(),n=D(),r=t.data.results;r=void 0===e.inspectorChartSearchFilter||null===e.inspectorChartSearchFilter?u("filter")(t.data.results,{}):u("filter")(t.data.results,{inspection_obj:{user:{username:e.inspectorChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.user){var e=t.inspection_obj.user.username;angular.forEach(n,function(n){if(n.name===e)for(var r=l.formatDatestring(t.timestamp),o=0;o<a.length;o++)moment(new Date(a[o])).format("MM/DD/YYYY")===moment(new Date(r)).format("MM/DD/YYYY")&&(n.data[o]=n.data[o]+1)})}}),b.highcharts({chart:{type:e.chartType},title:{text:"Inspections"},subtitle:{text:"Daily Inspection Breakdown"},xAxis:{categories:a,title:{text:"Days"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:n})}),M.highcharts({chart:{type:"column",events:{drilldown:function(t){if(!t.seriesOptions){var e=this,a={Animals:{name:"Animals",data:[["Cows",2],["Sheep",3]]},Fruits:{name:"Fruits",data:[["Apples",5],["Oranges",7],["Bananas",2]]},Cars:{name:"Cars",data:[["Toyota",1],["Volkswagen",2],["Opel",5]]}},n=a[t.point.name];e.showLoading("Simulating Ajax ..."),setTimeout(function(){e.hideLoading(),e.addSeriesAsDrilldown(t.point,n)},1e3)}}}},title:{text:"Drilldown"},xAxis:{type:"category"},legend:{enabled:!1},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0}}},series:[{name:"Things",colorByPoint:!0,data:[{name:"Animals",y:5,drilldown:!0},{name:"Fruits",y:2,drilldown:!0},{name:"Cars",y:4,drilldown:!0}]}],drilldown:{series:[]}})},e.UpdateCustomerChart=function(){e.fromUnix=moment(new Date(e.fromChartDate)).unix(),e.toUnix=moment(new Date(e.toChartDate)).unix(),s.getByDealerIdStartEnd(m.getDealerID(),e.fromUnix,e.toUnix).then(function(t){var a=d();e.chartCustomers=x(t.data.results);var n=C(),r=t.data.results;r=void 0===e.customerChartSearchFilter||null===e.customerChartSearchFilter?u("filter")(r,{}):u("filter")(r,{inspection_obj:{customer:{name:e.customerChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.customer){var e=t.inspection_obj.customer.name;angular.forEach(n,function(n){if(n.name===e)for(var r=moment.unix(t.timestamp).format("MM/DD/YYYY"),o=0;o<a.length;o++)moment(new Date(a[o])).format("MM/DD/YYYY")===moment(new Date(r)).format("MM/DD/YYYY")&&(n.data[o]=n.data[o]+1)})}}),Y.highcharts({chart:{type:e.chartType},title:{text:"Customers"},subtitle:{text:"Customer Frequency Breakdown"},xAxis:{categories:a,title:{text:"Days"}},yAxis:{min:0,title:{text:"Number of Customers"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:n})})},e.UpdateMachineChart=function(){e.fromUnix=moment(new Date(e.fromChartDate)).unix(),e.toUnix=moment(new Date(e.toChartDate)).unix(),s.getByDealerIdStartEnd(m.getDealerID(),e.fromUnix,e.toUnix).then(function(t){var a=d();e.chartMachines=y(t.data.results);var n=g(),r=t.data.results;r=void 0===e.machineChartSearchFilter||null===e.machineChartSearchFilter?u("filter")(r,{}):u("filter")(r,{inspection_obj:{machine:{model:e.machineChartSearchFilter}}}),angular.forEach(r,function(t){if(void 0!==t.inspection_obj.machine){var e=t.inspection_obj.machine.model;angular.forEach(n,function(n){if(n.name===e)for(var r=moment.unix(t.timestamp).format("MM/DD/YYYY"),o=0;o<a.length;o++)moment(new Date(a[o])).format("MM/DD/YYYY")===moment(new Date(r)).format("MM/DD/YYYY")&&(n.data[o]=n.data[o]+1)})}}),v.highcharts({chart:{type:e.chartType},title:{text:"Machines"},subtitle:{text:"Machine Types Breakdown"},xAxis:{categories:a,title:{text:"Days"}},yAxis:{min:0,title:{text:"Number of Inspections"}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td><td style="padding:0"><b>{point.y}</b></td></tr>',footerFormat:"</table>",shared:!0,useHTML:!0},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:n}),$("#spinner").hide()})},e.UpdateInspectorChart(),e.UpdateCustomerChart(),e.UpdateMachineChart(),e.selectedChartByInspector=function(){e.filterChartByInspector=null===e.inspectorChartSearchFilter?{}:{inspection_obj:{user:{username:e.inspectorChartSearchFilter}}}},e.selectedChartByCustomer=function(){e.filterChartByCustomer=null===e.customerChartSearchFilter?{}:{inspection_obj:{customer:{name:e.customerChartSearchFilter}}}}}]);
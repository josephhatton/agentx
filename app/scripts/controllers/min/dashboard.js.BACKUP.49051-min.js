Modustri.controller("DashboardCtrl",["$log","$scope","$routeParams","$location","$http","CustomerServices","MachineServices","InsServices","UserServices","AuthServices","Utilities","AppSettings","DealerServices","$filter","$q",function(e,t,n,r,o,i,a,l,s,u,c,f,m,p,d){"use strict";function h(){var e=moment();t.InspectionCache={},t.Inspections=[];var n=moment(t.filterValue_FromDate).subtract(5,"hours");e.add(19,"hours"),l.getByDealerIdStartEnd(u.getDealerID(),n.unix(),e.unix()).then(function(e){var n=e.data.results;t.InspectionCache=n,t.UpdateDispatch()})}function g(){var e=[];t.filter_Customers={},angular.forEach(t.Inspections,function(n){"undefined"!=typeof n.inspection_obj.customer&&null!==n.inspection_obj.customer&&-1===e.indexOf(n.inspection_obj.customer.id)&&(t.filter_Customers[n.inspection_obj.customer.id]=n.inspection_obj.customer,e.push(n.inspection_obj.customer.id))})}function _(){var e=38.582436,t=-90.386832,n=new google.maps.LatLng(e,t),r={zoom:5,mapTypeId:google.maps.MapTypeId.ROADMAP,center:n};T=new google.maps.Map(document.getElementById("dispatch-manager-map"),r)}function b(){I(),angular.forEach(t.Inspections,function(e){t.tblFilterCustomer(e)&&t.tblFilterModel(e)&&t.tblFilterFromRating(e)&&t.tblFilterMonth(e)&&t.tblFilterLastThis(e)&&t.tblFilterKeyword(e)&&setTimeout(y(e),100)})}function y(e){var t="./images/tmp.png";if(0!==e.job_site_id&&"undefined"!=typeof e.inspection_obj.jobsite){var n=e.inspection_obj.machine.main_image_id;n!==!1&&n>0?(t=f.BASE_URL+"imgtmb/"+n+"/",v(t,e)):(t="images/tmp.png",v(t,e))}}function v(e,n){var r=new google.maps.LatLng(n.inspection_obj.jobsite.lat,n.inspection_obj.jobsite.lon),o="Not Set";"undefined"!=typeof n.inspection_obj.customer&&(o=n.inspection_obj.customer.name);var i=new google.maps.InfoWindow({content:V(e,n,o)});t.InfoWindows.push(i);var a=new google.maps.Marker({position:r,map:T,mapTypeId:google.maps.MapTypeId.HYBRID,title:"Inspection Location",icon:n.markerIcon});google.maps.event.addListener(a,"click",function(){for(var e=0;e<t.InfoWindows.length;e++)t.InfoWindows[e].close();i.open(T,a)}),L.push(a)}function V(e,t,n){var r="";t.inspection_obj.hasOwnProperty("user")&&(r=t.inspection_obj.user.username);var o='<div class="map-data-container"><div class="map-image"><img alt="Inspection '+t.id+'" src="'+e+'"/></div><div class="map-data"><h3><a href="#/inspections/'+t.id+'">Inspection '+t.id+"</a></h3>Inspector: <strong>"+r+'</strong><br />Serial: <strong><a href="#/machines/'+t.machine_id+'">'+t.inspection_obj.machine.serial+"</a></strong><br />Customer: <strong>"+n+"</strong><br /></div></div>";return o}function w(e){for(var t=0;t<L.length;t++)L[t].setMap(e)}function M(){w(null)}function I(){M(),L=[]}function D(e){var t;return"undefined"!=typeof e&&null!==e&&"Hi"!==e&&"Lo"!==e&&"NA"!==e&&""!==e?parseFloat(e):void 0}function F(e){return"undefined"==typeof e||""===e||null===e?"green":e>69?"red":e>30&&70>e?"orange":31>e?"green":void 0}t.InspectionCache={},t.FilterLock=!1,t.FilterMD=function(){t.FilterLock=!1},t.FilterMU=function(){t.FilterLock=!1},t.filterValue_FromDate=localStorage.getItem("filterValue_FromDate")?localStorage.getItem("filterValue_FromDate"):moment().subtract(1,"months").format("MM/DD/YYYY"),t.filterValue_ToDate=localStorage.getItem("filterValue_ToDate")?localStorage.getItem("filterValue_ToDate"):moment().format("MM/DD/YYYY"),t.$watch("filterValue_FromDate",function(e){localStorage.setItem("filterValue_FromDate",e)}),t.$watch("filterValue_ToDate",function(e){localStorage.setItem("filterValue_ToDate",e)}),t.filterValue_Customer=-1,t.filterValue_Model=-1,t.filterValue_Month=0,t.filterValue_LastThis=0,t.filterValue_FromRating=0,t.filterValue_ToRating=120,t.filterValue_Keyword="";var x=$("#spinner");x.css("width","24px").css("height","24px"),x.show(),u.checkUserCreds(),t.UserSettings=u.getUserSettings(),m.getDealerImg(u.getDealerID()).then(function(e){if("image_id"in e.data.results&&null!==e.data.results.obj&&null!==e.data.results.image_id){var t=f.BASE_URL+"img/"+e.data.results.image_id+"/";$("#logo").css("background-image","url("+t+")").css("width","250px"),$(".logo-wrapper").css("width","250px")}});var k=moment();l.getInspectionCountByRange(moment("01-01-"+k.year(),"MM-DD-YYYY").unix(),k.unix()).then(function(e){e.data.results.length>0&&(t.Trend.ytd_inspections=e.data.results[0].dealer_inspections)}),t.Trend={ytd_inspections:0,ytd_sales:0,revenue:0,missed_opportunities:0,monthly_teamgoals:0,user_engagement:0,customer_engagement:0},h(),t.filter_Customers={},t.filter_Models={},a.queryModels().then(function(e){angular.forEach(e.data.results,function(e){t.filter_Models[e.id]=e})}),t.filter_Months=[{value:1,text:"January"},{value:2,text:"February"},{value:3,text:"March"},{value:4,text:"April"},{value:5,text:"May"},{value:6,text:"June"},{value:7,text:"July"},{value:8,text:"August"},{value:9,text:"September"},{value:10,text:"October"},{value:11,text:"November"},{value:12,text:"December"}];var T,L=[];t.InfoWindows=[],t.showTrends=1,t.showFilter=1,t.showMap=1,t.showhideTrends=function(e){t.showTrends=e},t.showhideFilter=function(e){t.showFilter=e},t.showhideMap=function(e){t.showMap=e},t.DispatchReady=!1,t.Inspections=[],t.ApplyFilters=function(){t.DispatchReady=!1,h()},t.ClearFilters=function(){t.filterValue_Customer=-1,t.filterValue_Model=-1,t.filterValue_Month=0,t.filterValue_LastThis=0,t.filterValue_FromRating=0,t.filterValue_ToRating=120,t.filterValue_Keyword=""},t.Spin=x,t.Loaded=!1,t.$watch("Loaded",function(e,n){e!==n&&(x.hide(),t.DispatchReady=!0)}),t.UpdateDispatch=function(){t.fromUnix=moment(t.filterValue_FromDate),t.toUnix=moment(t.filterValue_ToDate),t.fromUnix.subtract(5,"hours"),t.toUnix.add(19,"hours"),t.fromUnix=t.fromUnix.unix(),t.toUnix=t.toUnix.unix(),I();var e=t.InspectionCache.length,n=0;angular.forEach(t.InspectionCache,function(r,o){var a=parseInt(r.timestamp,10),l=parseInt(t.fromUnix,10),s=parseInt(t.toUnix,10);if(a>l&&s>a){t.Inspections.push(r),r.hasOwnProperty("datestring")||(r.datestring=c.getDatestring(r.timestamp)),r.inspection_obj.hasOwnProperty("customer")?r.customer_name=r.inspection_obj.customer.name:i.get(r.customer_id).then(function(e){r.customer_name=e.data.results.name});var u=[];r.components=[],r.totalimages=0,angular.forEach(r.inspection_obj.results,function(e,t){if(!("undefined"==typeof e[0]||"undefined"==typeof e[0].left&&"undefined"==typeof e[0].right||"undefined"==typeof e[0].left.percentage&&"undefined"==typeof e[0].right.percentage))for(var n=0;n<e.length;n++)u.push(D(e[n].left.percentage)),u.push(D(e[n].right.percentage)),e[n].component_type=t,e[n].left.percent=D(e[n].left.percentage),e[n].left.color=F(e[n].left.percent),e[n].right.percent=D(e[n].right.percentage),e[n].right.color=F(e[n].right.percent),r.components.push(e[n]),e[n].left.hasOwnProperty("image_timestamp")&&r.totalimages++,e[n].right.hasOwnProperty("image_timestamp")&&r.totalimages++});var f=u.sort(function(e,t){return t-e});"undefined"==typeof f[0]?(r.rating="N/A",r.rating_value=-1,r.color=""):(r.rating=f[0].toString()+"%",r.rating_value=f[0]),r.color=F(r.rating_value),r.markerIcon="http://maps.google.com/mapfiles/ms/icons/"+r.color+"-dot.png",r.inspection_jsonstring=angular.toJson(r,!0),r.show_components=0,y(r),n++,n>=e&&(t.Loaded=!0)}else n++}),t.DispatchReady=!0,g()},t.filterByCustomer=function(e){t.filterValue_Customer=e},t.tblFilterCustomer=function(e){return null===t.filterValue_Customer||""===t.filterValue_Customer||-1===t.filterValue_Customer?!0:e.inspection_obj.hasOwnProperty("customer")&&e.inspection_obj.customer.id===t.filterValue_Customer?!0:!1},t.filterByModel=function(e){t.filterValue_Model=e},t.tblFilterModel=function(e){return null===t.filterValue_Model||""===t.filterValue_Model||-1===t.filterValue_Model?!0:e.inspection_obj.hasOwnProperty("machine")&&e.inspection_obj.machine.model_id===t.filterValue_Model?!0:!1},t.tblFilterFromRating=function(e){return e.rating_value>=t.filterValue_FromRating&&e.rating_value<=t.filterValue_ToRating?!0:!1},t.filterByMonth=function(e){t.filterValue_LastThis=0,t.filterValue_Month=e},t.tblFilterMonth=function(e){return t.filterValue_Month>=1&&t.filterValue_Month<=9?null!==e.datestring.match("0"+t.filterValue_Month+"/[0-9][0-9]/[0-9][0-9][0-9][0-9]"):t.filterValue_Month>=10?null!==e.datestring.match(""+t.filterValue_Month+"/[0-9][0-9]/[0-9][0-9][0-9][0-9]"):!0},t.tblFilterKeyword=function(e){return e.inspection_jsonstring.toLowerCase().indexOf(t.filterValue_Keyword.toLowerCase())>=0?!0:!1},t.filterByLastThis=function(e){t.filterValue_LastThis===e?t.filterValue_LastThis=0:(t.filterValue_LastThis=e,t.filterValue_Month=0),t.filterValue_Month=0},t.tblFilterLastThis=function(e){var n=moment(e.datestring,"MM/DD/YYYY"),r=moment();switch(t.filterValue_LastThis){case 1:if(n.add(1,"weeks"),n.week()===r.week()&&n.year()===r.year())return!0;break;case 2:if(n.add(1,"months"),n.month()===r.month()&&n.year()===r.year())return!0;break;case 3:if(n.year()===r.year()&&n.month()===r.month()&&n.date()===r.date())return!0;break;case 4:if(n.week()===r.week()&&n.year()===r.year())return!0;break;case 5:if(n.month()===r.month()&&n.year()===r.year())return!0;break;default:return!0}return!1},t.$watch("filterValue_Customer",function(e,t){e!==t&&b()}),t.$watch("filterValue_Model",function(e,t){e!==t&&b()}),t.$watch("filterValue_FromRating",function(e,n){e===n||t.FilterLock||b()}),t.$watch("filterValue_ToRating",function(e,n){e===n||t.FilterLock||b()}),t.$watch("filterValue_Month",function(e,t){e!==t&&b()}),t.$watch("filterValue_LastThis",function(e,t){e!==t&&b()}),t.$watch("filterValue_Keyword",function(e,t){e!==t&&b()}),t.usv_component={track_links:{name:"Link",icon_cls:"links-btn"},bushings:{name:"Bushing",icon_cls:"bushings-btn"},track_shoes:{name:"Shoe",icon_cls:"shoes-btn"},idlers_front:{name:"Front Idler",icon_cls:"idlers-btn"},idlers_rear:{name:"Rear Idler",icon_cls:"idlers-btn"},carrier_rollers:{name:"Carrier Roller",icon_cls:"carrier-rollers-btn"},track_rollers:{name:"Track Roller",icon_cls:"track-rollers-btn"},sprockets:{name:"Sprocket",icon_cls:"sprockets-btn"}},_()}]);
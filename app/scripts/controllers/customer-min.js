Modustri.controller("CustomerCtrl",["$log","$scope","$routeParams","$location","CustomerServices","MachineServices","UserServices","InsServices","AuthServices","Utilities","AppSettings","ScoreBoardServices","$position","$modal","$q",function(e,t,a,n,r,i,o,s,c,d,l,u,p,m,h){"use strict";function f(e){var t=[];if("number"==typeof e&&(e=""+e+"%"),"undefined"!=typeof e&&null!==e&&"Hi"!==e&&"Lo"!==e&&"NA"!==e&&""!==e){try{t=e.split("%")}catch(a){}return t[0]}}function v(e,a){if(null!==e){var n={};switch(n.customer=e.inspection_obj.customer.name,n.model=e.inspection_obj.machine.model,n.serial=e.inspection_obj.machine.serial,n.equipment_id=null!==e.inspection_obj.machine.equipment_id?e.inspection_obj.machine.equipment_id:"",n.last_inspected=0===e.inspection_obj.machine.last_inspected?"":e.inspection_obj.machine.last_inspected,n.next_inspection_date="",n.hour_meter_reading=e.inspection_obj.hour_meter_reading,n.hours_per_week=e.inspection_obj.hours_per_week,null!==e.inspection_obj.jobsite?void 0!==e.inspection_obj.jobsite&&(n.jobsite=e.inspection_obj.jobsite.address):n.jobsite="",n.bushing_turned="No",n.percent_worn={},e.inspection_obj.results&&(n.percent_worn.links=g(e.inspection_obj.results,"track_links"),n.percent_worn.bushings=g(e.inspection_obj.results,"bushings"),n.percent_worn.shoes=g(e.inspection_obj.results,"track_shoes"),n.percent_worn.idlers_front=g(e.inspection_obj.results,"idlers_front"),n.percent_worn.idlers_rear=g(e.inspection_obj.results,"idlers_rear"),n.percent_worn.carrier_rollers=g(e.inspection_obj.results,"carrier_rollers"),n.percent_worn.track_rollers=g(e.inspection_obj.results,"track_rollers"),n.percent_worn.sprockets=g(e.inspection_obj.results,"sprockets")),n.hours_on_wear_surface={},e.inspection_obj.results&&(n.hours_on_wear_surface.links=b(e.inspection_obj.results,"track_links"),n.hours_on_wear_surface.bushings=b(e.inspection_obj.results,"bushings"),n.hours_on_wear_surface.shoes=b(e.inspection_obj.results,"track_shoes"),n.hours_on_wear_surface.idlers_front=b(e.inspection_obj.results,"idlers_front"),n.hours_on_wear_surface.idlers_rear=b(e.inspection_obj.results,"idlers_rear"),n.hours_on_wear_surface.carrier_rollers=b(e.inspection_obj.results,"carrier_rollers"),n.hours_on_wear_surface.track_rollers=b(e.inspection_obj.results,"track_rollers"),n.hours_on_wear_surface.sprockets=b(e.inspection_obj.results,"sprockets")),a){case"fleet":break;case"report2":n.action_required="OK",n.note=e.note}null!==n&&(t.ReportSummary[t.ReportSummary.length]=n)}}function g(e,t){var a="";return e&&e[t]&&(e[t].length>0&&(e[t]=e[t][0]),"undefined"!=typeof e[t].left&&"undefined"!=typeof e[t].left.percentage&&(a+=e[t].left.percentage,isNaN(e[t].left.percentage)||(a+="%")),"undefined"!=typeof e[t].right&&"undefined"!=typeof e[t].right.percentage&&(""!==a&&(a+=" - "),a+=e[t].right.percentage,isNaN(e[t].right.percentage)||(a+="%"))),a}function b(e,t){var a="";return e&&e[t]&&(e[t].length>0&&(e[t]=e[t][0]),"undefined"!=typeof e[t].left&&"undefined"!=typeof e[t].left.measured&&(a+=e[t].left.measured),"undefined"!=typeof e[t].right&&"undefined"!=typeof e[t].right.measured&&(""!==a&&(a+=" - "),a+=e[t].right.measured)),a}function M(){var e=[];return angular.forEach(t.Customer.MachineData,function(t){var a=$("#mach_"+t.id);a.is(":checked")&&e.push(t.id)}),e}var w=$("#spinner");w.show(),c.checkUserCreds(),t.UserSettings=c.getUserSettings(),t.SelectedAll=!1,t.Months={},t.past=12,t.fut=12,t.Customer={},t.CustInsCache=[],t.PartManufCache=[],t.ReportSummary=[],t.new_customer=!1,t.machine_page="",t.num_pages="",t.image_upload="",t.badges={},t.MachineActions={},t.MachineWearDates={},t.MachinesByID={},t.machine_page=1,t.ReportTypeList=[{id:"fleet",label:"Fleet Summary"},{id:"fleet_2",label:"Fleet Summary 2"}],t.ReportSummary=[];var y,C,x=n.url(),A=x.match(/edit/);t.UUID=function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?a:7&a|8).toString(16)});return t},t.UpdateScoreboardRange=function(){w.show(),t.Months={},t.MachineActions={};var e=moment().startOf("month"),a=t.past,n=t.fut;for(n=-1^n;a>n;){var r=moment().subtract(a,"months").startOf("month"),i=r.format("MMM YY"),o=r.format("MMM_YYYY"),s=r.unix();t.Months[s]={},t.Months[s].timestamp=s,t.Months[s].label=i,t.Months[s].idp=o.toLowerCase(),t.Months[s].active=s===e.unix()?!0:!1,a--}w.hide()},t.FmtMonth=function(e){return e=e.replace("_"," "),e.charAt(0).toUpperCase()+e.slice(1)},t.DeleteAction=function(e){confirm("Are you sure you want to delete this action?")&&u.deleteAction(e).then(function(){t.RefreshScoreboard(),$("#action_"+e).remove()})};var Y;t.MachineSummaryModal=function(e,a){var n=$("<div></div>");n.attr("id","hover_"+e+a);var r=t.MachinesByID[e],i=r.model+" "+r.serial+" - "+t.FmtMonth(a);n.attr("title",i);var o=t.MachineWearDates[e],s=t.MachineActions[e],c="n/a",d="n/a",u="n/a",p=!1;for(var m in o)(m>p||p===!1)&&(p=m);var _=o[p];if(void 0!==_&&_.hasOwnProperty("70")){var h="n/a";if(r.hasOwnProperty("rating")){c="Past",d="Past",u="Past",h=r.rating,i+=" - "+h,n.attr("title",i);var f=parseInt(r.rating_value,10),v="";f>69?v="bgred":70>f&&f>30?v="bgyellow":30>f&&(v="bggreen"),h='<span class="'+v+'">'+h+"</span>",69>f&&(c=new moment.unix(_.adate).add(_[70],"seconds").format("MMM YYYY")),99>f&&(d=new moment.unix(_.adate).add(_[100],"seconds").format("MMM YYYY")),119>f&&(u=new moment.unix(_.adate).add(_[120],"seconds").format("MMM YYYY"))}var g=$("<fieldset><legend>Wear Estimates</legend></fieldset>");g.addClass("wear_dates");var b=$("<div></div>").addClass("cal_modal_rating");b.append($('<span><img src="/images/formbuilder/green-arrow.svg" style="height: 10px;width: auto;"> 70% '+c+"</span><br>")),b.append($('<span><img src="/images/formbuilder/orange-arrow.svg" style="height: 10px;width: auto;"> 100% '+d+"</span><br>")),b.append($('<span><img src="/images/formbuilder/red-arrow.svg" style="height: 10px;width: auto;"> 120% '+u+"</span><br>"));var M=$("<div></div>").addClass("cal_modal_img"),w=!1,y="images/tmp.png";r.main_image_id>0&&(w=l.BASE_URL+"img/"+r.main_image_id+"/",y=l.BASE_URL+"imgtmb/"+r.main_image_id+"/"),M.append('<img src="'+y+'" width="100" height="100"/>'),g.append(M),g.append(b),n.append(g)}var C=0;Y=$("<fieldset><legend>Actions</legend></fieldset>").css("clear","both");for(var x in s){console.dir(s);for(var A in s[x]){var j=s[x][A];if(a===j.month){var k=$('<button value="'+j.id+'">Delete</button>');k.click(function(e){t.DeleteAction($(this).val())});var S=$('<div class="action_modal" id="action_'+j.id+'"><p><span><b>'+t.FmtMonth(j.month)+"</b> "+j.description+"</span><br>"+j.notes+"</p></div>");S.append(k),S.append($("<br>")),Y.append(S),C++}}}0===C&&Y.append($('<div class="action_modal" id="action_item"><p><span>No actions for this machine this month</span></p><br></div>')),n.append(Y);var D=e+a,I=$('<fieldset style="margin-top: 10px;"></fieldset>').css("clear","both");I.append($("<legend></legend>").append($("<button>Add Action</button>")).click(function(){$("#add_actions_"+D).toggle()}));var P=$('<div id="add_actions_'+D+'" style="display: none;"></div>');P.append('<label for="new_action_type_'+D+'">Action Type</label>');var U=$('<select id="new_action_type_'+D+'"></select>');U.append($('<option value="" selected>Please select Action type</option>'));for(var B in t.badges){var R=t.badges[B];U.append($('<option value="'+R.id+'">'+R.abr+" - "+R.description+"</option>"))}P.append(U);var E=$('<label for="new_action_note_'+D+'">Note</label>'),L=$("<textarea></textarea>");L.attr("id","new_action_note_"+D),L.attr("rows","3").attr("cols","30"),P.append(E),P.append(L);var N=$('<label for="cvtd_'+D+'">Converted to Sale</label>'),O=$('<input type="checkbox" value="1"></input>');O.attr("id","cvtd_"+D),P.append(N),P.append(O),P.append($("<br>"));var F=$('<label for="val_'+D+'">Value</label>'),T=$('<input type="number"></input>');T.attr("id","val_"+D),P.append(F),P.append(T),P.append('<input type="hidden" id="ac_mon_'+D+'" value="'+a+'">'),P.append($("<br>"));var W=$('<input type="submit" value="Submit"></input>');W.click(function(e){t.AddAction(D)}),W.attr("id","submit_"+D),P.append(W),I.append(P),n.append(I),n.dialog({position:{of:$("#mon_ac_"+e+"_"+a),my:"top left",at:"top left"}})},t.AddAction=function(e){if(0===$("#new_action_type_"+e).val())return void alert("Action Type was not selected.");var a=$("#cvtd_"+e).val(),n=$("#val_"+e).val(),r=$("#ac_mon_"+e).val(),i=r.split("_"),o=$("#new_action_type_"+e).val(),s=$("#new_action_type_"+e+"  option:selected").text(),c=$("#new_action_note_"+e).val(),d=e.replace(r,""),l=moment(r).unix(),p=t.UUID(),m={machine_id:d,action_id:o,notes:c,converted:a,value:n+"",date:l,id:t.UUID()};u.saveAction(m).then(function(a){t.RefreshScoreboard(),$("#cvtd_"+e).val(""),$("#val_"+e).val(""),$("#new_action_type_"+e).val(""),$("#new_action_note_"+e).val(""),alert("Action saved");var n=$("#action_item").text();n.contains("No actions for this machine")&&$("#action_item").remove();var r=$('<button value="'+p+'">Delete</button>');r.click(function(e){t.DeleteAction($(this).val())});var o=$('<div class="action_modal" id="action_'+p+'"><p><span><b>'+i[0]+" "+i[1]+"</b> "+s+"</span><br>"+c+"</p>");o.append(r),o.append($("<br>")),Y.append(o)})},t.CheckAll=function(){t.SelectedAll=t.SelectedAll===!1?!0:!1,angular.forEach(t.Customer.MachineData,function(e){var a=$("#mach_"+e.id);a.prop("checked",t.SelectedAll)})},t.state=_.isArray(A)&&"edit"===A[0]?"edit":"view";var j=function(){i.getPartManufacturers().then(function(e){void 0!==e&&angular.forEach(e.data.results,function(e){t.PartManufCache[e.id]=e.name})})};t.RefreshScoreboard=function(){w.show(),S()},t.getScoreBoardActions=function(){u.getAllScoreBoardData("actions",function(e){angular.forEach(e.results,function(e){t.badges[e.id]=e})})},t.updateMachineActions=function(){u.getAllScoreBoardData("machineactiondates",function(e){angular.forEach(e.results,function(e){var a=t.badges[e.action_id],n=e;n.abr=a.abr,n.description=a.description,n.show=!0,n.month=moment.unix(e.date).format("MMM_YYYY").toLowerCase(),t.MachineActions.hasOwnProperty(n.machine_id)||(t.MachineActions[n.machine_id]={},t.MachineActions[n.machine_id][n.month]={}),t.MachineActions[n.machine_id].hasOwnProperty(n.month)||(t.MachineActions[n.machine_id][n.month]={}),t.MachineActions[n.machine_id][n.month][n.id]=n});for(var a in t.MachineActions)for(var n in t.MachineActions[a]){var r=$('<span class="scorbrd_act_badge" id="'+t.UUID()+'">'+Object.keys(t.MachineActions[a][n]).length+"</span>"),i="";for(var o in t.MachineActions[a][n]){var s=t.MachineActions[a][n][o];i+='<span class="scorbrd_act_badge">'+s.abr+"</span>"}var c=$("#mon_ac_"+a+"_"+n);void 0!==c.parent()&&c.append(r)}})},t.FailCalc=function(e,t,a){return s.FailCalc(e,t,a)};var k={};t.updateMachineFailDates=function(){for(var e in t.MachinesByID)i.getProjections(e).then(t.HandleProjection)},t.HandleProjection=function(e){var a=e.data.machine_id,n=t.MachinesByID[a];t.MachineWearDates.hasOwnProperty(a)||(t.MachineWearDates[a]={});var r=[];for(var i in e.data.results){var o=!1,s=e.data.results[i];for(var c in s){var d=s[c];if(r.hasOwnProperty(d.adate)||(r[d.adate]=d.a_ins_id),r.hasOwnProperty(d.bdate)||(r[d.bdate]=d.b_ins_id),-1!==d.apct&&-1!==d.bpct)if(o===!1)o=d;else{var l=d.l_h[70],u=d.r_h[70],p=o.r_h[70],m=o.l_h[70];if(0!==l||0!==u)(m>l||p>u)&&(o=d);else{var _=d.l_date[70],h=d.r_date[70],f=o.l_date[70],v=o.r_date[70];(f>_||v>h)&&(o=d)}}}if(o!==!1){var g=o.l_date;o.l_date[70]===!1&&o.r_date[70]!==!1?g=o.r_date:o.l_date[70]>o.r_date[70]&&(g=o.r_date);var b=new moment.unix(o.adate),M=new moment.unix(o.adate).add(g[70],"seconds").format("MMM_YYYY").toLowerCase(),w=new moment.unix(o.adate).add(g[100],"seconds").format("MMM_YYYY").toLowerCase(),y=new moment.unix(o.adate).add(g[120],"seconds").format("MMM_YYYY").toLowerCase();if(g[70]>g[120]||g[70]===g[120]);else{var C=g;C.rating=o.apct>o.bpct?o.apct:o.bpct,C.adate=o.adate,t.MachineWearDates[a][o.a_ins_id]=C,$("#stat_"+a+"_"+M).html('<img src="/images/formbuilder/green-arrow.svg" style="height: 15px;width: auto;">').tooltip({content:"70% projected date"}),$("#stat_"+a+"_"+w).html('<img src="/images/formbuilder/orange-arrow.svg" style="height: 15px;width: auto;">').tooltip({content:"100% projected date"}),$("#stat_"+a+"_"+y).html('<img src="/images/formbuilder/red-arrow.svg" style="height: 15px;width: auto;">').tooltip({content:"120% projected date"})}}}if(r.length>0)for(var x in r){var A=moment.unix(x).format("MMM_YYYY").toLowerCase(),Y=r[x];$("#stat_"+a+"_"+A+"_insp").html('<span class="scorbrd_ins"><img src="/images/formbuilder/ipad-tools.svg" style="height: 20px;width: auto;"></span>')}};var S=function(e){t.getScoreBoardActions(),t.UpdateScoreboardRange(),i.getByCustomerId(t.Customer.id,1,1).then(function(e){t.Customer.total_machines=e.data.pages}),i.getByCustomerId(t.Customer.id,e).then(function(e){var a=h.defer();t.num_pages=e.data.pages;var n=e.data.results;for(var r in n)for(var i in n[r])("(null)"===n[r][i]||"null"===n[r][i])&&(n[r][i]="N/A");t.Customer.MachineData=n;for(var r in e.data.results){var o=e.data.results[r];t.MachinesByID[o.id]=o}t.Customer.last_inspected=0!==t.Customer.last_inspected&&"number"==typeof t.Customer.last_inspected?d.getDatestring(t.Customer.last_inspected):0;var c=0;return t.Customer.MachineData.length>0&&(c=t.Customer.MachineData[t.Customer.MachineData.length-1].id),angular.forEach(t.Customer.MachineData,function(e){void 0!==e.manufacturer_id&&(e.part_manuf=t.PartManufCache[e.manufacturer_id]),e.last_inspected=0===e.last_inspected?"":d.getDatestring(e.last_inspected),s.getNewestInspectionByMachineId(e.id).then(function(n){if(void 0!==n.data.results&&void 0!==n.data.results[0]){e.last_ispected=n.data.results[0].inspection_obj.modified;var r=moment.unix(e.last_inspected).format("MMM_YYYY").toLowerCase();$("#stat_"+e.id+"_"+r+"_insp").html('<span class="scorbrd_ins"><img src="/images/formbuilder/ipad-tools.svg" style="height: 20px;width: auto;"></span>'),t.CustInsCache[e.id]={newest:n.data.results[0]},n.data.results.length>1&&(t.CustInsCache[e.id].previous=n.data.results[1])}e.id===c&&a.resolve({last_id:c})})}),s.getByCustomerId(t.Customer.id).then(function(e){t.Customer.total_inspections=e.data.results.length||0}),a.promise}).then(function(){var e=h.defer();return angular.forEach(t.Customer.MachineData,function(a){var n=[];if(void 0!==t.CustInsCache[a.id]&&t.CustInsCache[a.id].hasOwnProperty("newest")){var r=t.CustInsCache[a.id].newest.inspection_obj.results;angular.forEach(r,function(e){if(!(void 0===e[0]||void 0===e[0].left&&void 0===e[0].right||void 0===e[0].left.percentage&&void 0===e[0].right.percentage))for(var t=0;t<e.length;t++)n.push(f(e[t].left.percentage)),n.push(f(e[t].right.percentage))})}var i=n.sort(function(e,t){return t-e});void 0===i[0]?(a.rating="N/A",a.rating_value=-1,a.bgcolor=""):(i[0]=parseInt(i[0],10),a.rating=i[0].toString()+"%",a.rating_value=i[0],i[0]>69&&(a.bgcolor="bgred"),i[0]>30&&i[0]<70&&(a.bgcolor="bgyellow"),i[0]<31&&(a.bgcolor="bggreen")),e.resolve(!0)}),e.promise}).then(function(){t.updateMachineFailDates(),t.updateMachineActions(),w.hide()})};r.get(a.customerID).then(function(e){t.Customer=e.data.results,t.Customer.image_id>0&&(t.Customer.img=l.BASE_URL+"imgtmb/"+t.Customer.image_id+"/",t.Customer.img_full=l.BASE_URL+"img/"+t.Customer.image_id+"/",y=setTimeout(function(){C=document.createElement("img"),C.src=t.Customer.img_full},0)),null!==t.Customer.primary_contact_id&&0!==t.Customer.primary_contact_id?o.getContactById(t.Customer.primary_contact_id).then(function(e){t.Customer.email=e.data.results.email}):t.Customer.email="",j(),S(),t.Customer.hide_upload="edit"===t.state?!1:!0}),t.cancelCustomer=function(){n.path("/customers/"+t.Customer.id)},t.saveCustomer=function(){if(!d.validateForm(t.customer_form))return!1;var e=!0;r.getByName(t.Customer.name).then(function(a){if(a.data.results.length>0)for(var i=0;i<a.data.results.length;i++)if(a.data.results[i].id!=t.Customer.id&&t.Customer.name==a.data.results[i].name){e=!1;break}if(!e)return alert("Duplicate name exists."),!1;var s={};delete t.Customer.archived,o.saveContact(t.Customer.email).then(function(e){t.Customer.primary_contact_id=e!==!1?e.data.results.id:0,r.save(t.Customer).then(function(e){""!==t.image_upload?(s={customer_obj:e.data.results,file:t.image_upload,description:"Customer image",user_id:c.getUserID()},r.savePhoto(s).then(function(){t.$emit("obj_saved","Customer"),alert("Customer saved."),n.path("/customers/"+t.Customer.id)})):(t.$emit("obj_saved","Customer"),alert("Customer saved."),n.path("/customers/"+t.Customer.id))})})})},t.deleteCustomer=function(){confirm("Are you sure you want to delete this customer?")&&r.del(t.Customer.id).then(function(){n.path("/customers/list/")})},t.checkMonth=function(e,t){var a=moment.unix(e.timestamp).format("MM"),n=moment.unix(t).format("MM"),r=moment.unix(e.timestamp).format("YYYY"),i=moment.unix(t).format("YYYY");return a===n&&r===i},t.createReport=function(e){var a=M();if(0===a.length)return void alert("Please choose machines.");if(null===e)return void alert("Please select report type.");var n=0;angular.forEach(a,function(r){if(void 0!==t.CustInsCache[r]){var o=t.CustInsCache[r].newest;i.get(r).then(function(r){o.inspection_obj.machine.serial=r.data.results.serial,v(o,e),++n==a.length&&setTimeout(function(){t.printReport("report_cont_"+e)},400)})}})},t.printReport=function(e){var t=$("#"+e),a=t.html(),n=window.open("","_blank","width=1024,height=768,scrollbars=yes",!0);n.document.open(),n.document.write('<html><head> <link rel="stylesheet" href="styles/resets.css"><link rel="stylesheet" href="styles/formalize.css"><link rel="stylesheet" href="styles/animate.css"><link rel="stylesheet" href="styles/main.css"><link rel="stylesheet" href="styles/misc.css"><link rel="stylesheet" href="styles/print.css" media="print" /></head><body onload="window.print()">'+a+"</html>"),n.document.close()}}]);
//# sourceMappingURL=./customer-min.js.map
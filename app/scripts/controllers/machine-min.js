Modustri.controller("MachineCtrl",["$log","$scope","$routeParams","$location","MachineServices","InsServices","CustomerServices","ScoreBoardServices","Utilities","AuthServices","UserServices","AppSettings",function(e,t,n,i,a,r,c,s,o,u,l,d){"use strict";function h(e){var t;return"undefined"!=typeof e&&null!==e&&"Hi"!==e&&"Lo"!==e&&"NA"!==e&&""!==e?parseFloat(e):void 0}function m(e){return"undefined"==typeof e||""===e||null===e?"red":e>69?"red":e>30&&70>e?"orange":31>e?"green":void 0}u.checkUserCreds(),t.UserSettings=u.getUserSettings();var g=i.url(),p=g.match(/edit/),f,M,v=u.getDealerID();t.image_upload="",t.customer_changed=!1,t.state=_.isArray(p)&&"edit"===p[0]?"edit":"view",t.AllMachineActionDates=[],t.MachineActions=[],a.get(n.machineID,!1).then(function(e){t.Machine=e.data.results,t.Machine.serial=t.Machine.serial.trim().length>0?t.Machine.serial:"N/A",t.Machine.equipment_id=t.Machine.equipment_id.trim().length>0?t.Machine.equipment_id:"N/A",t.Machine.hide_upload="edit"===t.state?!1:!0,t.Inspections=[],""!==t.Machine.main_image_id&&"false"!=t.Machine.main_image_id&&0!=t.Machine.main_image_id&&"(null)"!=t.Machine.main_image_id&&(t.Machine.img=d.BASE_URL+"imgtmb/"+t.Machine.main_image_id+"/",t.Machine.img_full=d.BASE_URL+"img/"+t.Machine.main_image_id+"/",f=setTimeout(function(){M=document.createElement("img"),M.src=t.Machine.img_full},0)),0!=e.data.results.customer_id&&c.get(e.data.results.customer_id).then(function(e){t.Customer=e.data.results,t.Machine.customer_name=e.data.results.name,t.Customer.url="#/customers/"+e.data.results.id+"/",null!==t.Customer.primary_contact_id&&0!==t.Customer.primary_contact_id?l.getContactById(t.Customer.primary_contact_id).then(function(e){t.Customer.email=e.data.results.email,console.log(e.data.results)}):t.Customer.email=""}),r.getByMachineId(t.Machine.id).then(function(e){t.Inspections=e.data.results.sort(function(e,t){return t.timestamp-e.timestamp}),_.each(t.Inspections,function(e,t,n){e.datestring=o.getDatestring(e.timestamp),e.update_datestamp=o.getDatestring(e.modified),e.inspector=e.inspection_obj.hasOwnProperty("user")&&void 0!==e.inspection_obj.user.username?e.inspection_obj.user.username:"NA",e.imagescount=0;var i=[];e.components=[],angular.forEach(e.inspection_obj.results,function(t,n){if(!("undefined"==typeof t[0]||"undefined"==typeof t[0].left&&"undefined"==typeof t[0].right||"undefined"==typeof t[0].left.percentage&&"undefined"==typeof t[0].right.percentage))for(var a=0;a<t.length;a++)i.push(h(t[a].left.percentage)),i.push(h(t[a].right.percentage)),t[a].component_type=n,t[a].left.percent=h(t[a].left.percentage),t[a].left.color=m(t[a].left.percent),t[a].right.percent=h(t[a].right.percentage),t[a].right.color=m(t[a].right.percent),e.components.push(t[a]),t[a].left.hasOwnProperty("image_timestamp")&&e.imagescount++,t[a].right.hasOwnProperty("image_timestamp")&&e.imagescount++});var a=i.sort(function(e,t){return t-e});"undefined"==typeof a[0]?(e.rating="N/A",e.color="red"):(e.rating=a[0].toString()+"%",e.color=m(a[0])),e.show_components=0})}),a.queryManufacturers().then(function(e){t.ManufacturerList=e.data.results;var n=_.where(e.data.results,{id:t.Machine.manufacturer_id}),i=n[0].company.trim();i=i.length>0?i:"N/A",t.Machine.manufacturer_name=i,a.queryModels(t.Machine.manufacturer_id).then(function(e){t.ModelList=e.data.results})}),t.updateMachineModels=function(e){a.queryModels(t.Machine.manufacturer_id).then(function(e){t.ModelList=e.data.results})},t.$watch("Machine.model_id",function(e,n){if(e!==n){var i=_.where(t.ModelList,{id:e});t.Machine.model=i[0].model}}),s.getAllScoreBoardData("actions",function(e){t.MachineActions=e.results,s.getAllScoreBoardData("machineactiondates",function(e){t.AllMachineActionDates=e.results,t.Machine.opportunity="",angular.forEach(t.AllMachineActionDates,function(e,i){e.machine_id==n.machineID&&(t.Machine.opportunity=t.Machine.opportunity+t.MachineActions[parseInt(e.action_id)-1].abr+" ")})})})}),t.$watch("image_upload",function(e,t){}),t.saveMachine=function(){var e={},n=function(){a.save(t.Machine).then(function(n){alert("Machine saved."),t.$emit("machine_saved",n),""!==t.image_upload?(console.log("uploading image"),e={machine_obj:n.data.results,machine_id:n.data.results.id,file:t.image_upload,customer_id:n.data.results.customer_id,description:"",user_id:u.getUserID()},a.savePhoto(e).then(function(e){console.log("saved image"),console.dir(e),i.path("/machines/"+t.Machine.id)})):i.path("/machines/"+t.Machine.id)})};if(delete t.Machine.archived,t.customer_changed){var c;r.getByMachineId(t.Machine.id).then(function(e){e.data.results.length>0&&angular.forEach(e.data.results,function(e){e.customer_id=t.Machine.customer_id,c=e.id,delete e.id,delete e.archived,delete e.modified,e.inspection_obj=JSON.stringify(e.inspection_obj),r.save(e,c)}),n()})}else n()},t.deleteMachine=function(){confirm("Are you sure you want to delete this machine?")&&a.del(t.Machine.id).then(function(e){i.path("/machines/list/")})},t.usv_component={track_links:{name:"Link",icon_cls:"links-btn"},bushings:{name:"Bushing",icon_cls:"bushings-btn"},track_shoes:{name:"Shoe",icon_cls:"shoes-btn"},idlers_front:{name:"Front Idler",icon_cls:"idlers-btn"},idlers_rear:{name:"Rear Idler",icon_cls:"idlers-btn"},carrier_rollers:{name:"Carrier Roller",icon_cls:"carrier-rollers-btn"},track_rollers:{name:"Track Roller",icon_cls:"track-rollers-btn"},sprockets:{name:"Sprocket",icon_cls:"sprockets-btn"}}}]);
//# sourceMappingURL=./machine-min.js.map